# eBPF揭示隐藏的超能力

如果你是性能工程师/网络工程师甚至是安全工程师，以后接触到eBPF技术的几率是非常大的。eBPF 现在拥有庞大的用户社区，包括像 Meta、Google、Cloudflare 和 Netflix 这样的大公司，他们都在日常运营中使用这项技术。

![img](https://996station.com/wp-content/uploads/2022/11/20221126085437312.png?imageView2/0/format/webp/q/75)

# 序幕

让我以一个真实的故事开始博客。一年前，我的一个朋友打电话给我讨论技术（这是我们之间很常见的事情）。我们分享我们每个人在工作场所或我们的任何同行面临的不同技术挑战，这些讨论导致一些信息丰富和创造性的知识共享会议。在这样的讨论中，他描述了在一家大型云提供商工作的堂兄所面临的具体挑战。挑战在于动态限制某些 IP，因为它们提供诸如 DOS（拒绝服务攻击）之类的威胁，我的应用程序开发人员的大脑冲动地回答说这些应该在防火墙级别处理，或者可以编写中间件来检查数据包的来源并为恶意发件人维护黑名单并忽略请求（是的，我来自 NodeJS 和 Go 背景，所以最初的解决方案作为中间件罢工）。我的朋友耐心地解释了这需要执行的规模和性能，这超出了我的理解范围。经过一个新手的疑惑清理会议后，我们同意他想要的规模只能在内核级别实现。我祝他好运（讽刺地）编写内核补丁并提出 PR，希望操作系统维护者将内核补丁包含在即将发布的内核版本中，并且他可以在发布时使用此功能。作为对我讽刺的回应，他与我分享了一篇文章的链接，该文章详细介绍了名为“eBPF”（扩展的 Berkeley 数据包过滤器）的东西。

根据 eBPF，你可以直接将代码注入内核，而无需编写补丁，等待 OS 维护者的批准，

“直接在操作系统内核中运行您的自定义代码” **— LIZ RICE**

“Linux 的超能力”。—**布伦丹·格雷格斯**

![img](https://996station.com/wp-content/uploads/2022/11/20221126085508415.png?imageView2/0/format/webp/q/75)

注意：我在参考部分添加了一些视频和博客链接，请查看 eBPF 的一些精彩会议和博客。

# 历史

eBPF 于 2014 年问世，在 Linux 内核 3.18 中引入，从而解锁了 Linux 内核的上帝模式。任何阅读此博客的人自然会怀疑这个名字。如果这是一个“扩展的伯克利包过滤器”，那么应该有一个 BPF“伯克利包过滤器”。嗯，你是对的。BSD 包过滤器并不是一个新概念。它是从 90 年代开始的。这颗宝石多年来一直隐藏在雷达之下，Xennails 是真正的创新者。BPF 非常基础，它唯一的工作就是在内核级别过滤数据包，因此得名。

注意：我添加了 1992 年 12 月 19 日发表的原始 BPF 论文，这是一篇非常有趣的文章。

eBPF 已经从 BPF 走了很长一段路，BPF 只是一个数据包过滤实用程序，到考虑内核的微服务架构或他们称之为微内核。如今，所有大规模运营的顶级科技公司每天都在使用 eBPF。现在的 CNCF 社区依靠 eBPF 呼吸和生存，如果您是 DevOps 工程师或系统管理员，您会听说过 cilium 和 Falco，它们在 Kubernetes 用户和基于 eBPF 编写的生产工具中都很流行。2018 年 Linux 宣布将在内核中用 eBPF 版本替换其基于 iptable 的实现（用任何解决方案替换 iptable 会更好），回退和使用 iptables 的缺点超出了本文的范围，请转到参考部分并找到一篇关于它的写得很好的文章。Kubernetes 主要将 iptables 用于以下用例

- Kube-proxy — 通过 DNAT iptables 规则实现服务和负载均衡的组件
- 大多数 CNI 插件都使用 iptables 作为网络策略

Cilium 通过消除性能下降的 iptable 使其更加高效。你可以参考[这里](https://cilium.io/blog/2018/04/17/why-is-the-kernel-community-replacing-iptables)的细节。

# 程序执行 Bozo 的指南

要解释 eBPF 的重要性，就需要解释一下程序在 Linux 中是如何执行的，我会尝试从 1000ft 的角度为大家解释。

注意：Windows 用户？那么你为什么还要阅读这篇文章，你们没有所有这些很酷的功能。

Linux内存分为两部分

1. 内核空间
2. 用户空间

![img](https://996station.com/wp-content/uploads/2022/11/20221126085457970.png?imageView2/0/format/webp/q/75)

图像本身解释了这两者之间的区别。您编写的所有程序都只是作为内核 API 的系统调用的集合。举个例子，通过你最喜欢的编程语言打开一个文件，它只是在内核中转换成一个 fileopen 系统调用。

当您的应用程序向内核请求某些东西时，内核空间中的一大块数据经常被复制到用户空间中。我们必须这样做，因为操作系统严格划分内核使用的内存区域，因此不可能简单地向用户空间程序提供指向内核内存某个区域的指针。这被称为“跨越用户/内核边界”，由于复制操作，此类操作可能会对性能产生重大影响。



虽然系统调用几乎涵盖了所有情况，但有时会出现这还不够的情况，例如当我们需要内核级性能或编写新的驱动程序时，等等。依赖操作系统维护人员为所有这些小用例打补丁是一种浪费时间和一个不可能的过程。这就是 ebpf 发挥作用的地方。

eBPF 帮助您在用户空间编写程序，这些程序被打包并直接注入内核，这些程序在内核中的 VM 上运行，指令集有限，从而扩展了基本内核模块的功能。

# eBPF 剖析

eBPF 是为各种进程运行在内核上运行的自定义代码的规定，例如

- 可观察性（追踪）
- 调试
- 防火墙
- 负载均衡
- 网络相关活动

任何在内核中跟踪过各种程序的人都知道它的难度。Linux 系统中可用的半生不熟的实用程序不足以配置复杂的系统，甚至不足以扩展 perf 工具。

Ebpf 是事件驱动的，这意味着它会在以下情况下触发

- 一个系统调用
- 函数入口/出口
- 当数据包进入或离开时
- K 探头或 U 探头

这些程序是用一种称为 restricted c 的语言编写的，这种语言具有有限的指令集。BPF 编译器 BCC 将其转换为字节码，并加载到内核中执行。在编译之前运行验证程序以确保没有无限循环或可能导致内核崩溃的永无止境的 I/O 操作。

# 袖子下的额外技巧

ebpf 确实是一个您可以随身携带的强大工具。在处理高性能项目时，调整数据包或扩展跟踪功能都可以帮助您更好地观察系统正在发生的事情。尽管现阶段应用开发者遇到ebpf是很无力的，但如果你是性能工程师/网络工程师，甚至是安全工程师，未来遇到ebpf的机率将是千钧一发。

在编写 ebpf 程序时有一些注意事项，由于 ebpf 在 sudo 权限下运行，因此已经发生了几次利用 ebpf 的权限升级攻击。在利用内核内存漏洞时，ebpf 程序可以用作强大的辅助工具。Qualys 发现了利用此类漏洞的详细文章，他们有一篇文章，您可以从[此处](https://www.qualys.com/2021/07/20/cve-2021-33909/sequoia-local-privilege-escalation-linux.txt)参考。

# 结论

正如蜘蛛侠电影中所说的“能力越大，责任越大”，当你解锁 Linux 的上帝模式时，你就只能靠自己了，保护你的程序免于破坏整体的守卫现在不可用了。使用 Ebpf 有特定的用例，它不是解决所有性能问题的瑞士刀。社区现在非常庞大，包括像 meta、google、Cloudflare 和 Netflix 这样的大公司每天都在使用这项技术。该技术具有巨大的增长潜力，近年来已经看到了针对 ebpf 爱好者的单独会议。

这个博客为不了解这项酷技术的人提供了一个小机会，所以请进行研究。网上有大量关于 ebpf 和基于它构建的开源项目的资源。我将写一篇后续文章，详细介绍如何编写示例 ebpf 程序并执行它。

# 参考

- BPF 研究论文链接发表于 1992 年 — https://www.tcpdump.org/papers/bpf-usenix93.pdf
- Brendann Gregg 谈论 eBPF -
- https://www.facebook.com/atscaleevents/videos/1693888610884236/
- https://www.youtube.com/watch?v=w8nFRoFJ6EQ
- iptables 博客上的 Ebpf — https://cilium.io/blog/2018/04/17/why-is-the-kernel-community-replacing-iptables
- Qualys 漏洞 — https://www.qualys.com/2021/07/20/cve-2021-33909/sequoia-local-privilege-escalation-linux.txt





## 原文链接

https://coffeebeans-brewinginnovations.medium.com/ebpf-divulging-the-hidden-super-power-181f96291ef7