# eBPFå®Œå…¨å…¥é—¨æŒ‡å—



![img](https://996station.com/wp-content/uploads/2022/11/20221126113432460.png?imageView2/0/format/webp/q/75)

eBPF æºäº **BPF**[1]ï¼Œæœ¬è´¨ä¸Šæ˜¯å¤„äºå†…æ ¸ä¸­çš„ä¸€ä¸ªé«˜æ•ˆä¸çµæ´»çš„è™šç±»è™šæ‹Ÿæœºç»„ä»¶ï¼Œä»¥ä¸€ç§å®‰å…¨çš„æ–¹å¼åœ¨è®¸å¤šå†…æ ¸ hook ç‚¹æ‰§è¡Œå­—èŠ‚ç ã€‚BPF æœ€åˆçš„ç›®çš„æ˜¯ç”¨äºé«˜æ•ˆç½‘ç»œæŠ¥æ–‡è¿‡æ»¤ï¼Œç»è¿‡é‡æ–°è®¾è®¡ï¼ŒeBPF ä¸å†å±€é™äºç½‘ç»œåè®®æ ˆï¼Œå·²ç»æˆä¸ºå†…æ ¸é¡¶çº§çš„å­ç³»ç»Ÿï¼Œæ¼”è¿›ä¸ºä¸€ä¸ªé€šç”¨æ‰§è¡Œå¼•æ“ã€‚å¼€å‘è€…å¯åŸºäº eBPF å¼€å‘æ€§èƒ½åˆ†æå·¥å…·ã€è½¯ä»¶å®šä¹‰ç½‘ç»œã€å®‰å…¨ç­‰è¯¸å¤šåœºæ™¯ã€‚æœ¬æ–‡å°†ä»‹ç» eBPF çš„å‰ä¸–ä»Šç”Ÿï¼Œå¹¶æ„å»ºä¸€ä¸ª eBPF ç¯å¢ƒè¿›è¡Œå¼€å‘å®è·µï¼Œæ–‡ä¸­æ‰€æœ‰çš„ä»£ç å¯ä»¥åœ¨æˆ‘çš„ **Github**[2] ä¸­æ‰¾åˆ°ã€‚

## æŠ€æœ¯èƒŒæ™¯

### å‘å±•å†å²

BPFï¼Œæ˜¯ç±» Unix ç³»ç»Ÿä¸Šæ•°æ®é“¾è·¯å±‚çš„ä¸€ç§åŸå§‹æ¥å£ï¼Œæä¾›åŸå§‹é“¾è·¯å±‚å°åŒ…çš„æ”¶å‘ã€‚1992 å¹´ï¼ŒSteven McCanne å’Œ Van Jacobson å†™äº†ä¸€ç¯‡åä¸º **The BSD Packet Filter: A New Architecture for User-level Packet Capture**[3] çš„è®ºæ–‡ã€‚åœ¨æ–‡ä¸­ï¼Œä½œè€…æè¿°äº†ä»–ä»¬å¦‚ä½•åœ¨ Unix å†…æ ¸å®ç°ç½‘ç»œæ•°æ®åŒ…è¿‡æ»¤ï¼Œè¿™ç§æ–°çš„æŠ€æœ¯æ¯”å½“æ—¶æœ€å…ˆè¿›çš„æ•°æ®åŒ…è¿‡æ»¤æŠ€æœ¯å¿« 20 å€ã€‚

![img](https://996station.com/wp-content/uploads/2022/11/20221126114410510.png?imageView2/0/format/webp/q/75)

BPF åœ¨æ•°æ®åŒ…è¿‡æ»¤ä¸Šå¼•å…¥äº†ä¸¤å¤§é©æ–°ï¼š

- ä¸€ä¸ªæ–°çš„è™šæ‹Ÿæœº (VM) è®¾è®¡ï¼Œå¯ä»¥æœ‰æ•ˆåœ°å·¥ä½œåœ¨åŸºäºå¯„å­˜å™¨ç»“æ„çš„ CPU ä¹‹ä¸Š
- åº”ç”¨ç¨‹åºä½¿ç”¨ç¼“å­˜åªå¤åˆ¶ä¸è¿‡æ»¤æ•°æ®åŒ…ç›¸å…³çš„æ•°æ®ï¼Œä¸ä¼šå¤åˆ¶æ•°æ®åŒ…çš„æ‰€æœ‰ä¿¡æ¯ï¼Œè¿™æ ·å¯ä»¥æœ€å¤§ç¨‹åº¦åœ°å‡å°‘ BPF å¤„ç†çš„æ•°æ®

**äº‘åŸç”Ÿå®éªŒå®¤**

æˆ˜ç•¥ä¸Šè—è§†äº‘åŸç”Ÿï¼Œæˆ˜æœ¯ä¸Šé‡è§†äº‘åŸç”Ÿ

141ç¯‡åŸåˆ›å†…å®¹

å…¬ä¼—å·

ç”±äºè¿™äº›å·¨å¤§çš„æ”¹è¿›ï¼Œæ‰€æœ‰çš„ Unix ç³»ç»Ÿéƒ½é€‰æ‹©é‡‡ç”¨ BPF ä½œä¸ºç½‘ç»œæ•°æ®åŒ…è¿‡æ»¤æŠ€æœ¯ï¼Œç›´åˆ°ä»Šå¤©ï¼Œè®¸å¤š Unix å†…æ ¸çš„æ´¾ç”Ÿç³»ç»Ÿä¸­ï¼ˆåŒ…æ‹¬ Linux å†…æ ¸ï¼‰ä»ä½¿ç”¨è¯¥å®ç°ã€‚tcpdump çš„åº•å±‚é‡‡ç”¨ BPF ä½œä¸ºåº•å±‚åŒ…è¿‡æ»¤æŠ€æœ¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å‘½ä»¤åé¢å¢åŠ  `-d` æ¥æŸ¥çœ‹ tcpdump è¿‡æ»¤æ¡ä»¶çš„åº•å±‚æ±‡ç¼–æŒ‡ä»¤ã€‚

```
$ tcpdump -d 'ip and tcp port 8080'
(000) ldh      [12]
(001) jeq      #0x800           jt 2 jf 12
(002) ldb      [23]
(003) jeq      #0x6             jt 4 jf 12
(004) ldh      [20]
(005) jset     #0x1fff          jt 12 jf 6
(006) ldxb     4*([14]&0xf)
(007) ldh      [x + 14]
(008) jeq      #0x1f90          jt 11 jf 9
(009) ldh      [x + 16]
(010) jeq      #0x1f90          jt 11 jf 12
(011) ret      #262144
(012) ret      #0
```

2014 å¹´åˆï¼ŒAlexei Starovoitov å®ç°äº† eBPFï¼ˆextended Berkeley Packet Filterï¼‰ã€‚ç»è¿‡é‡æ–°è®¾è®¡ï¼ŒeBPF æ¼”è¿›ä¸ºä¸€ä¸ªé€šç”¨æ‰§è¡Œå¼•æ“ï¼Œå¯åŸºäºæ­¤å¼€å‘æ€§èƒ½åˆ†æå·¥å…·ã€è½¯ä»¶å®šä¹‰ç½‘ç»œç­‰è¯¸å¤šåœºæ™¯ã€‚**eBPF æœ€æ—©å‡ºç°åœ¨ 3.18 å†…æ ¸ä¸­ï¼Œæ­¤ååŸæ¥çš„ BPF å°±è¢«ç§°ä¸ºç»å…¸ BPFï¼Œç¼©å†™ cBPFï¼ˆclassic BPFï¼‰ï¼ŒcBPF ç°åœ¨å·²ç»åŸºæœ¬åºŸå¼ƒã€‚ç°åœ¨ï¼ŒLinux å†…æ ¸åªè¿è¡Œ eBPFï¼Œå†…æ ¸ä¼šå°†åŠ è½½çš„ cBPF å­—èŠ‚ç é€æ˜åœ°è½¬æ¢æˆ eBPF å†æ‰§è¡Œ**ã€‚

### eBPF ä¸ cBPF

eBPF æ–°çš„è®¾è®¡é’ˆå¯¹ç°ä»£ç¡¬ä»¶è¿›è¡Œäº†ä¼˜åŒ–ï¼Œæ‰€ä»¥ eBPF ç”Ÿæˆçš„æŒ‡ä»¤é›†æ¯”æ—§çš„ BPF è§£é‡Šå™¨ç”Ÿæˆçš„æœºå™¨ç æ‰§è¡Œå¾—æ›´å¿«ã€‚æ‰©å±•ç‰ˆæœ¬ä¹Ÿå¢åŠ äº†è™šæ‹Ÿæœºä¸­çš„å¯„å­˜å™¨æ•°é‡ï¼Œå°†åŸæœ‰çš„ 2 ä¸ª 32 ä½å¯„å­˜å™¨å¢åŠ åˆ° 10 ä¸ª 64 ä½å¯„å­˜å™¨ã€‚ç”±äºå¯„å­˜å™¨æ•°é‡å’Œå®½åº¦çš„å¢åŠ ï¼Œå¼€å‘äººå‘˜å¯ä»¥ä½¿ç”¨å‡½æ•°å‚æ•°è‡ªç”±äº¤æ¢æ›´å¤šçš„ä¿¡æ¯ï¼Œç¼–å†™æ›´å¤æ‚çš„ç¨‹åºã€‚æ€»ä¹‹ï¼Œè¿™äº›æ”¹è¿›ä½¿ eBPF ç‰ˆæœ¬çš„é€Ÿåº¦æ¯”åŸæ¥çš„ BPF æé«˜äº† 4 å€ã€‚

| ç»´åº¦           | cBPF                      | eBPF                                                         |
| -------------- | ------------------------- | ------------------------------------------------------------ |
| å†…æ ¸ç‰ˆæœ¬       | Linux 2.1.75ï¼ˆ1997 å¹´ï¼‰   | Linux 3.18ï¼ˆ2014 å¹´ï¼‰[4.x for kprobe/uprobe/tracepoint/perf-event] |
| å¯„å­˜å™¨æ•°ç›®     | 2 ä¸ªï¼šA, X                | 10 ä¸ªï¼šR0â€“R9, å¦å¤– R10 æ˜¯ä¸€ä¸ªåªè¯»çš„å¸§æŒ‡é’ˆ - R0 eBPF ä¸­å†…æ ¸å‡½æ•°çš„è¿”å›å€¼å’Œé€€å‡ºå€¼ - R1 - R5 eBF ç¨‹åºåœ¨å†…æ ¸ä¸­çš„å‚æ•°å€¼ - R6 - R9 å†…æ ¸å‡½æ•°å°†ä¿å­˜çš„è¢«è°ƒç”¨è€… callee ä¿å­˜çš„å¯„å­˜å™¨ - R10 ä¸€ä¸ªåªè¯»çš„å †æ ˆå¸§æŒ‡é’ˆ |
| å¯„å­˜å™¨å®½åº¦     | 32 ä½                     | 64 ä½                                                        |
| å­˜å‚¨           | 16 ä¸ªå†…å­˜ä½: M[0â€“15]      | 512 å­—èŠ‚å †æ ˆï¼Œæ— é™åˆ¶å¤§å°çš„ `map` å­˜å‚¨                        |
| é™åˆ¶çš„å†…æ ¸è°ƒç”¨ | éå¸¸æœ‰é™ï¼Œä»…é™äº JIT ç‰¹å®š | æœ‰é™ï¼Œé€šè¿‡ bpf_call æŒ‡ä»¤è°ƒç”¨                                 |
| ç›®æ ‡äº‹ä»¶       | æ•°æ®åŒ…ã€ seccomp-BPF      | æ•°æ®åŒ…ã€å†…æ ¸å‡½æ•°ã€ç”¨æˆ·å‡½æ•°ã€è·Ÿè¸ªç‚¹ PMCs ç­‰                   |

2014 å¹´ 6 æœˆï¼Œ**eBPF æ‰©å±•åˆ°ç”¨æˆ·ç©ºé—´ï¼Œè¿™ä¹Ÿæˆä¸ºäº† BPF æŠ€æœ¯çš„è½¬æŠ˜ç‚¹**ã€‚æ­£å¦‚ Alexei åœ¨æäº¤è¡¥ä¸çš„æ³¨é‡Šä¸­å†™åˆ°ï¼šã€Œè¿™ä¸ªè¡¥ä¸å±•ç¤ºäº† eBPF çš„æ½œåŠ›ã€ã€‚å½“å‰ï¼ŒeBPF ä¸å†å±€é™äºç½‘ç»œæ ˆï¼Œå·²ç»æˆä¸ºå†…æ ¸é¡¶çº§çš„å­ç³»ç»Ÿã€‚

### eBPF ä¸å†…æ ¸æ¨¡å—

å¯¹æ¯” Web çš„å‘å±•ï¼ŒeBPF ä¸å†…æ ¸çš„å…³ç³»æœ‰ç‚¹ç±»ä¼¼äº JavaScript ä¸æµè§ˆå™¨å†…æ ¸çš„å…³ç³»ï¼ŒeBPF ç›¸æ¯”äºç›´æ¥ä¿®æ”¹å†…æ ¸å’Œç¼–å†™å†…æ ¸æ¨¡å—æä¾›äº†ä¸€ç§æ–°çš„å†…æ ¸å¯ç¼–ç¨‹çš„é€‰é¡¹ã€‚eBPF ç¨‹åºæ¶æ„å¼ºè°ƒå®‰å…¨æ€§å’Œç¨³å®šæ€§ï¼Œçœ‹ä¸Šå»æ›´åƒå†…æ ¸æ¨¡å—ï¼Œä½†ä¸å†…æ ¸æ¨¡å—ä¸åŒï¼ŒeBPF ç¨‹åºä¸éœ€è¦é‡æ–°ç¼–è¯‘å†…æ ¸ï¼Œå¹¶ä¸”å¯ä»¥ç¡®ä¿ eBPF ç¨‹åºè¿è¡Œå®Œæˆï¼Œè€Œä¸ä¼šé€ æˆç³»ç»Ÿçš„å´©æºƒã€‚

| ç»´åº¦                | Linux å†…æ ¸æ¨¡å—                       | eBPF                                           |
| ------------------- | ------------------------------------ | ---------------------------------------------- |
| kprobes/tracepoints | æ”¯æŒ                                 | æ”¯æŒ                                           |
| **å®‰å…¨æ€§**          | å¯èƒ½å¼•å…¥å®‰å…¨æ¼æ´æˆ–å¯¼è‡´å†…æ ¸ Panic     | é€šè¿‡éªŒè¯å™¨è¿›è¡Œæ£€æŸ¥ï¼Œå¯ä»¥ä¿éšœå†…æ ¸å®‰å…¨           |
| å†…æ ¸å‡½æ•°            | å¯ä»¥è°ƒç”¨å†…æ ¸å‡½æ•°                     | åªèƒ½é€šè¿‡ BPF Helper å‡½æ•°è°ƒç”¨                   |
| ç¼–è¯‘æ€§              | éœ€è¦ç¼–è¯‘å†…æ ¸                         | ä¸éœ€è¦ç¼–è¯‘å†…æ ¸ï¼Œå¼•å…¥å¤´æ–‡ä»¶å³å¯                 |
| è¿è¡Œ                | åŸºäºç›¸åŒå†…æ ¸è¿è¡Œ                     | åŸºäºç¨³å®š ABI çš„ BPF ç¨‹åºå¯ä»¥ç¼–è¯‘ä¸€æ¬¡ï¼Œå„å¤„è¿è¡Œ |
| ä¸åº”ç”¨ç¨‹åºäº¤äº’      | æ‰“å°æ—¥å¿—æˆ–æ–‡ä»¶                       | é€šè¿‡ perf_event æˆ– map ç»“æ„                    |
| æ•°æ®ç»“æ„ä¸°å¯Œæ€§      | ä¸€èˆ¬                                 | ä¸°å¯Œ                                           |
| **å…¥é—¨é—¨æ§›**        | é«˜                                   | ä½                                             |
| **å‡çº§**            | éœ€è¦å¸è½½å’ŒåŠ è½½ï¼Œå¯èƒ½å¯¼è‡´å¤„ç†æµç¨‹ä¸­æ–­ | åŸå­æ›¿æ¢å‡çº§ï¼Œä¸ä¼šé€ æˆå¤„ç†æµç¨‹ä¸­æ–­             |
| å†…æ ¸å†…ç½®            | è§†æƒ…å†µè€Œå®š                           | å†…æ ¸å†…ç½®æ”¯æŒ                                   |

### eBPF æ¶æ„

eBPF åˆ†ä¸ºç”¨æˆ·ç©ºé—´ç¨‹åºå’Œå†…æ ¸ç¨‹åºä¸¤éƒ¨åˆ†ï¼š

- ç”¨æˆ·ç©ºé—´ç¨‹åºè´Ÿè´£åŠ è½½ BPF å­—èŠ‚ç è‡³å†…æ ¸ï¼Œå¦‚éœ€è¦ä¹Ÿä¼šè´Ÿè´£è¯»å–å†…æ ¸å›ä¼ çš„ç»Ÿè®¡ä¿¡æ¯æˆ–è€…äº‹ä»¶è¯¦æƒ…
- å†…æ ¸ä¸­çš„ BPF å­—èŠ‚ç è´Ÿè´£åœ¨å†…æ ¸ä¸­æ‰§è¡Œç‰¹å®šäº‹ä»¶ï¼Œå¦‚éœ€è¦ä¹Ÿä¼šå°†æ‰§è¡Œçš„ç»“æœé€šè¿‡ maps æˆ–è€… perf-event äº‹ä»¶å‘é€è‡³ç”¨æˆ·ç©ºé—´
- å…¶ä¸­ç”¨æˆ·ç©ºé—´ç¨‹åºä¸å†…æ ¸ BPF å­—èŠ‚ç ç¨‹åºå¯ä»¥ä½¿ç”¨ map ç»“æ„å®ç°åŒå‘é€šä¿¡ï¼Œè¿™ä¸ºå†…æ ¸ä¸­è¿è¡Œçš„ BPF å­—èŠ‚ç ç¨‹åºæä¾›äº†æ›´åŠ çµæ´»çš„æ§åˆ¶

eBPF æ•´ä½“ç»“æ„å›¾å¦‚ä¸‹ï¼š

![img](https://996station.com/wp-content/uploads/2022/11/20221126114345890.png?imageView2/0/format/webp/q/75)

ç”¨æˆ·ç©ºé—´ç¨‹åºä¸å†…æ ¸ä¸­çš„ BPF å­—èŠ‚ç äº¤äº’çš„æµç¨‹ä¸»è¦å¦‚ä¸‹ï¼š

1. ä½¿ç”¨ LLVM æˆ–è€… GCC å·¥å…·å°†ç¼–å†™çš„ BPF ä»£ç ç¨‹åºç¼–è¯‘æˆ BPF å­—èŠ‚ç 
2. ä½¿ç”¨åŠ è½½ç¨‹åº Loader å°†å­—èŠ‚ç åŠ è½½è‡³å†…æ ¸
3. å†…æ ¸ä½¿ç”¨éªŒè¯å™¨ï¼ˆVerfierï¼‰ ç»„ä»¶ä¿è¯æ‰§è¡Œå­—èŠ‚ç çš„å®‰å…¨æ€§ï¼Œä»¥é¿å…å¯¹å†…æ ¸é€ æˆç¾éš¾ï¼Œåœ¨ç¡®è®¤å­—èŠ‚ç å®‰å…¨åå°†å…¶åŠ è½½å¯¹åº”çš„å†…æ ¸æ¨¡å—æ‰§è¡Œ
4. å†…æ ¸ä¸­è¿è¡Œçš„ BPF å­—èŠ‚ç ç¨‹åºå¯ä»¥ä½¿ç”¨ä¸¤ç§æ–¹å¼å°†æ•°æ®å›ä¼ è‡³ç”¨æˆ·ç©ºé—´
   - **maps** æ–¹å¼å¯ç”¨äºå°†å†…æ ¸ä¸­å®ç°çš„ç»Ÿè®¡æ‘˜è¦ä¿¡æ¯ï¼ˆæ¯”å¦‚æµ‹é‡å»¶è¿Ÿã€å †æ ˆä¿¡æ¯ï¼‰ç­‰å›ä¼ è‡³ç”¨æˆ·ç©ºé—´ï¼›
   - **perf-event** ç”¨äºå°†å†…æ ¸é‡‡é›†çš„äº‹ä»¶å®æ—¶å‘é€è‡³ç”¨æˆ·ç©ºé—´ï¼Œç”¨æˆ·ç©ºé—´ç¨‹åºå®æ—¶è¯»å–åˆ†æï¼›

### eBPF é™åˆ¶

eBPF æŠ€æœ¯è™½ç„¶å¼ºå¤§ï¼Œä½†æ˜¯ä¸ºäº†ä¿è¯å†…æ ¸çš„å¤„ç†å®‰å…¨å’ŒåŠæ—¶å“åº”ï¼Œå†…æ ¸ä¸­çš„ eBPF æŠ€æœ¯ä¹Ÿç»™äºˆäº†è¯¸å¤šé™åˆ¶ï¼Œå½“ç„¶éšç€æŠ€æœ¯çš„å‘å±•å’Œæ¼”è¿›ï¼Œé™åˆ¶ä¹Ÿåœ¨é€æ­¥æ”¾å®½æˆ–è€…æä¾›äº†å¯¹åº”çš„è§£å†³æ–¹æ¡ˆã€‚

- eBPF ç¨‹åºä¸èƒ½è°ƒç”¨ä»»æ„çš„å†…æ ¸å‚æ•°ï¼Œåªé™äºå†…æ ¸æ¨¡å—ä¸­åˆ—å‡ºçš„ BPF Helper å‡½æ•°ï¼Œå‡½æ•°æ”¯æŒåˆ—è¡¨ä¹Ÿéšç€å†…æ ¸çš„æ¼”è¿›åœ¨ä¸æ–­å¢åŠ ã€‚
- eBPF ç¨‹åºä¸å…è®¸åŒ…å«æ— æ³•åˆ°è¾¾çš„æŒ‡ä»¤ï¼Œé˜²æ­¢åŠ è½½æ— æ•ˆä»£ç ï¼Œå»¶è¿Ÿç¨‹åºçš„ç»ˆæ­¢ã€‚
- eBPF ç¨‹åºä¸­å¾ªç¯æ¬¡æ•°é™åˆ¶ä¸”å¿…é¡»åœ¨æœ‰é™æ—¶é—´å†…ç»“æŸï¼Œè¿™ä¸»è¦æ˜¯ç”¨æ¥é˜²æ­¢åœ¨ kprobes ä¸­æ’å…¥ä»»æ„çš„å¾ªç¯ï¼Œå¯¼è‡´é”ä½æ•´ä¸ªç³»ç»Ÿï¼›è§£å†³åŠæ³•åŒ…æ‹¬å±•å¼€å¾ªç¯ï¼Œå¹¶ä¸ºéœ€è¦å¾ªç¯çš„å¸¸è§ç”¨é€”æ·»åŠ è¾…åŠ©å‡½æ•°ã€‚Linux 5.3 åœ¨ BPF ä¸­åŒ…å«äº†å¯¹æœ‰ç•Œå¾ªç¯çš„æ”¯æŒï¼Œå®ƒæœ‰ä¸€ä¸ªå¯éªŒè¯çš„è¿è¡Œæ—¶é—´ä¸Šé™ã€‚
- eBPF å †æ ˆå¤§å°è¢«é™åˆ¶åœ¨ MAX_BPF_STACKï¼Œæˆªæ­¢åˆ°å†…æ ¸ Linux 5.8 ç‰ˆæœ¬ï¼Œè¢«è®¾ç½®ä¸º 512ï¼›å‚è§ **include/linux/filter.h**[4]ï¼Œè¿™ä¸ªé™åˆ¶ç‰¹åˆ«æ˜¯åœ¨æ ˆä¸Šå­˜å‚¨å¤šä¸ªå­—ç¬¦ä¸²ç¼“å†²åŒºæ—¶ï¼šä¸€ä¸ª char[256]ç¼“å†²åŒºä¼šæ¶ˆè€—è¿™ä¸ªæ ˆçš„ä¸€åŠã€‚ç›®å‰æ²¡æœ‰è®¡åˆ’å¢åŠ è¿™ä¸ªé™åˆ¶ï¼Œè§£å†³æ–¹æ³•æ˜¯æ”¹ç”¨ bpf æ˜ å°„å­˜å‚¨ï¼Œå®ƒå®é™…ä¸Šæ˜¯æ— é™çš„ã€‚`*/\* BPF program can access up to 512 bytes of stack space. \*/*#define MAX_BPF_STACK 512`
- eBPF å­—èŠ‚ç å¤§å°æœ€åˆè¢«é™åˆ¶ä¸º 4096 æ¡æŒ‡ä»¤ï¼Œæˆªæ­¢åˆ°å†…æ ¸ Linux 5.8 ç‰ˆæœ¬ï¼Œ å½“å‰å·²å°†æ”¾å®½è‡³ 100 ä¸‡æŒ‡ä»¤ï¼ˆ BPF_COMPLEXITY_LIMIT_INSNSï¼‰ï¼Œå‚è§ï¼š**include/linux/bpf.h**[5]ï¼Œå¯¹äºæ— æƒé™çš„ BPF ç¨‹åºï¼Œä»ç„¶ä¿ç•™ 4096 æ¡é™åˆ¶ ( BPF_MAXINSNS )ï¼›æ–°ç‰ˆæœ¬çš„ eBPF ä¹Ÿæ”¯æŒäº†å¤šä¸ª eBPF ç¨‹åºçº§è”è°ƒç”¨ï¼Œè™½ç„¶ä¼ é€’ä¿¡æ¯å­˜åœ¨æŸäº›é™åˆ¶ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡ç»„åˆå®ç°æ›´åŠ å¼ºå¤§çš„åŠŸèƒ½ã€‚`#define BPF_COMPLEXITY_LIMIT_INSNS   1000000 */\* yes. 1M insns \*/*`

## eBPF å®æˆ˜

åœ¨æ·±å…¥ä»‹ç» eBPF ç‰¹æ€§ä¹‹å‰ï¼Œè®©æˆ‘ä»¬ `Get Hands Dirty`ï¼Œåˆ‡åˆ‡å®å®çš„æ„Ÿå— eBPF ç¨‹åºåˆ°åº•æ˜¯ä»€ä¹ˆï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•å¼€å‘ eBPF ç¨‹åºã€‚éšç€ eBPF ç”Ÿæ€çš„æ¼”è¿›ï¼Œç°åœ¨å·²ç»æœ‰è¶Šæ¥è¶Šå¤šçš„å·¥å…·é“¾ç”¨äºå¼€å‘ eBPF ç¨‹åºï¼Œåœ¨åæ–‡ä¹Ÿä¼šè¯¦ç»†ä»‹ç»ï¼š

- åŸºäº bcc å¼€å‘ï¼šbcc æä¾›äº†å¯¹ eBPF å¼€å‘ï¼Œå‰æ®µæä¾› Python APIï¼Œåç«¯ eBPF ç¨‹åºé€šè¿‡ C å®ç°ã€‚ç‰¹ç‚¹æ˜¯ç®€å•æ˜“ç”¨ï¼Œä½†æ˜¯æ€§èƒ½è¾ƒå·®ã€‚
- åŸºäº libebpf-bootstrap å¼€å‘ï¼šlibebpf-bootstrap æä¾›äº†ä¸€ä¸ªæ–¹ä¾¿çš„è„šæ‰‹æ¶
- åŸºäºå†…æ ¸æºç å¼€å‘ï¼šå†…æ ¸æºç å¼€å‘é—¨æ§›è¾ƒé«˜ï¼Œä½†æ˜¯ä¹Ÿæ›´åŠ åˆ‡åˆ eBPF åº•å±‚åŸç†ï¼Œæ‰€ä»¥è¿™é‡Œä»¥è¿™ä¸ªæ–¹æ³•ä½œä¸ºç¤ºä¾‹

### å†…æ ¸æºç ç¼–è¯‘

ç³»ç»Ÿç¯å¢ƒå¦‚ä¸‹ï¼Œé‡‡ç”¨è…¾è®¯äº‘ CVMï¼ŒUbuntu 20.04ï¼Œå†…æ ¸ç‰ˆæœ¬ 5.4.0

```
$ uname -a
Linux VM-1-3-ubuntu 5.4.0-42-generic #46-Ubuntu SMP Fri Jul 10 00:24:02 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux
```

é¦–å…ˆå®‰è£…å¿…è¦ä¾èµ–ï¼š

```
$ sudo apt install -y bison build-essential cmake flex git libedit-dev pkg-config libmnl-dev \
   python zlib1g-dev libssl-dev libelf-dev libcap-dev libfl-dev llvm clang pkg-config \
   gcc-multilib luajit libluajit-5.1-dev libncurses5-dev libclang-dev clang-tools
```

ä¸€èˆ¬æƒ…å†µä¸‹æ¨èé‡‡ç”¨ apt æ–¹å¼çš„å®‰è£…æºç ï¼Œå®‰è£…ç®€å•è€Œä¸”åªå®‰è£…å½“å‰å†…æ ¸çš„æºç ï¼Œæºç çš„å¤§å°åœ¨ 200M å·¦å³ã€‚

```
$ apt-cache search linux-source
$ apt install linux-source-5.4.0
```

æºç å®‰è£…è‡³ `/usr/src/` ç›®å½•ä¸‹ã€‚

```
$ ls -hl
total 4.0K
drwxr-xr-x 4 root root 4.0K Nov  9 13:22 linux-source-5.4.0
lrwxrwxrwx 1 root root   45 Oct 15 10:28 linux-source-5.4.0.tar.bz2 -> linux-source-5.4.0/linux-source-5.4.0.tar.bz2
$ tar -jxvf linux-source-5.4.0.tar.bz2
$ cd linux-source-5.4.0

$ cp -v /boot/config-$(uname -r) .config # make defconfig æˆ–è€… make menuconfig
$ make headers_install
$ make modules_prepare
$ make scripts     # å¯é€‰
$ make M=samples/bpf  # å¦‚æœé…ç½®å‡ºé”™ï¼Œå¯ä»¥ä½¿ç”¨ make oldconfig && make prepare ä¿®å¤
```

ç¼–è¯‘æˆåŠŸåï¼Œå¯ä»¥åœ¨ `samples/bpf` ç›®å½•ä¸‹çœ‹åˆ°ä¸€ç³»åˆ—çš„ç›®æ ‡æ–‡ä»¶å’ŒäºŒè¿›åˆ¶æ–‡ä»¶ã€‚

### Hello World

å‰é¢è¯´åˆ° eBPF é€šå¸¸ç”±å†…æ ¸ç©ºé—´ç¨‹åºå’Œç”¨æˆ·ç©ºé—´ç¨‹åºä¸¤éƒ¨åˆ†ç»„æˆï¼Œç°åœ¨ `samples/bpf` ç›®å½•ä¸‹æœ‰å¾ˆå¤šè¿™ç§ç¨‹åºï¼Œå†…æ ¸ç©ºé—´ç¨‹åºä»¥ `_kern.c` ç»“å°¾ï¼Œç”¨æˆ·ç©ºé—´ç¨‹åºä»¥ `_user.c` ç»“å°¾ã€‚å…ˆä¸çœ‹è¿™äº›å¤æ‚çš„ç¨‹åºï¼Œæˆ‘ä»¬æ‰‹åŠ¨å†™ä¸€ä¸ª eBPF ç¨‹åºçš„ Hello Worldã€‚

å†…æ ¸ä¸­çš„ç¨‹åº `hello_kern.c`ï¼š

```
#include <linux/bpf.h>
#include "bpf_helpers.h"

#define SEC(NAME) __attribute__((section(NAME), used))

SEC("tracepoint/syscalls/sys_enter_execve")
int bpf_prog(void *ctx)
{
    char msg[] = "Hello BPF from houmin!\n";
    bpf_trace_printk(msg, sizeof(msg));
    return 0;
}

char _license[] SEC("license") = "GPL";
```

#### å‡½æ•°å…¥å£

ä¸Šè¿°ä»£ç å’Œæ™®é€šçš„ C è¯­è¨€ç¼–ç¨‹æœ‰ä¸€äº›åŒºåˆ«ã€‚

1. ç¨‹åºçš„å…¥å£é€šè¿‡ç¼–è¯‘å™¨çš„ `pragama __section("tracepoint/syscalls/sys_enter_execve")` æŒ‡å®šçš„ã€‚
2. å…¥å£çš„å‚æ•°ä¸å†æ˜¯ `argc, argv`, å®ƒæ ¹æ®ä¸åŒçš„ prog type è€Œæœ‰æ‰€å·®åˆ«ã€‚æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œprog type æ˜¯ `BPF_PROG_TYPE_TRACEPOINT`ï¼Œ å®ƒçš„å…¥å£å‚æ•°å°±æ˜¯ `void *ctx`ã€‚

#### å¤´æ–‡ä»¶

```
**#include <linux/bpf.h>**
```

è¿™ä¸ªå¤´æ–‡ä»¶çš„æ¥æºæ˜¯ kernel source header file ã€‚å®ƒå®‰è£…åœ¨ `/usr/include/linux/bpf.h`ä¸­ã€‚

å®ƒæä¾›äº† bpf ç¼–ç¨‹éœ€è¦çš„å¾ˆå¤š symbolã€‚ä¾‹å¦‚

1. enum bpf_func_id å®šä¹‰äº†æ‰€æœ‰çš„ kerne helper function çš„ id
2. enum bpf_prog_type å®šä¹‰äº†å†…æ ¸æ”¯æŒçš„æ‰€æœ‰çš„ prog çš„ç±»å‹ã€‚
3. struct __sk_buff æ˜¯ bpf ä»£ç ä¸­è®¿é—®å†…æ ¸ struct sk_buff çš„æ¥å£ã€‚

ç­‰ç­‰

**#include â€œbpf_helpers.hâ€**

æ¥è‡ª libbpf ï¼Œéœ€è¦è‡ªè¡Œå®‰è£…ã€‚æˆ‘ä»¬å¼•ç”¨è¿™ä¸ªå¤´æ–‡ä»¶æ˜¯å› ä¸ºè°ƒç”¨äº† bpf_printk()ã€‚è¿™æ˜¯ä¸€ä¸ª kernel helper functionã€‚

#### ç¨‹åºè§£é‡Š

è¿™é‡Œæˆ‘ä»¬ç®€å•è§£è¯»ä¸‹å†…æ ¸æ€çš„ `ebpf` ç¨‹åºï¼Œéå¸¸ç®€å•ï¼š

- `bpf_trace_printk` æ˜¯ä¸€ä¸ª eBPF helper å‡½æ•°ï¼Œç”¨äºæ‰“å°ä¿¡æ¯åˆ° `trace_pipe` (/sys/kernel/debug/tracing/trace_pipe)ï¼Œ**è¯¦è§è¿™é‡Œ**[6]
- ä»£ç å£°æ˜äº† `SEC` å®ï¼Œå¹¶ä¸”å®šä¹‰äº† GPL çš„ Licenseï¼Œè¿™æ˜¯å› ä¸ºåŠ è½½è¿›å†…æ ¸çš„ eBPF ç¨‹åºéœ€è¦æœ‰ License æ£€æŸ¥ï¼Œç±»ä¼¼äºå†…æ ¸æ¨¡å—

#### åŠ è½½ BPF ä»£ç 

ç”¨æˆ·æ€ç¨‹åº `hello_user.c`

```
#include <stdio.h>
#include "bpf_load.h"

int main(int argc, char **argv)
{
    if(load_bpf_file("hello_kern.o") != 0)
    {
        printf("The kernel didn't load BPF program\n");
        return -1;
    }

    read_trace_pipe();
    return 0;
}
```

åœ¨ç”¨æˆ·æ€ `ebpf` ç¨‹åºä¸­ï¼Œè§£è¯»å¦‚ä¸‹ï¼š

- é€šè¿‡ `load_bpf_file` å°†ç¼–è¯‘å‡ºçš„å†…æ ¸æ€ ebpf ç›®æ ‡æ–‡ä»¶åŠ è½½åˆ°å†…æ ¸
- é€šè¿‡ **`read_trace_pipe`**[7] ä» `trace_pipe` è¯»å– trace ä¿¡æ¯ï¼Œæ‰“å°åˆ°æ§åˆ¶å°ä¸­

ä¿®æ”¹ `samples/bpf` ç›®å½•ä¸‹çš„ `Makefile` æ–‡ä»¶ï¼Œåœ¨å¯¹åº”çš„ä½ç½®æ·»åŠ ä»¥ä¸‹ä¸‰è¡Œï¼š

```
hostprogs-y += hello
hello-objs := bpf_load.o hello_user.o
always += hello_kern.o
```

é‡æ–°ç¼–è¯‘ï¼Œå¯ä»¥çœ‹åˆ°ç¼–è¯‘æˆåŠŸçš„æ–‡ä»¶

```
$ make M=samples/bpf
$ ls -hl samples/bpf/hello*
-rwxrwxr-x 1 ubuntu ubuntu 404K Mar 30 17:48 samples/bpf/hello
-rw-rw-r-- 1 ubuntu ubuntu  317 Mar 30 17:47 samples/bpf/hello_kern.c
-rw-rw-r-- 1 ubuntu ubuntu 3.8K Mar 30 17:48 samples/bpf/hello_kern.o
-rw-rw-r-- 1 ubuntu ubuntu  246 Mar 30 17:47 samples/bpf/hello_user.c
-rw-rw-r-- 1 ubuntu ubuntu 2.2K Mar 30 17:48 samples/bpf/hello_user.o
```

è¿›å…¥åˆ°å¯¹åº”çš„ç›®å½•è¿è¡Œ `hello` ç¨‹åºï¼Œå¯ä»¥çœ‹åˆ°è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š

```
$ sudo ./hello
           <...>-102735 [001] ....  6733.481740: 0: Hello BPF from houmin!

           <...>-102736 [000] ....  6733.482884: 0: Hello BPF from houmin!

           <...>-102737 [002] ....  6733.483074: 0: Hello BPF from houmin!
```

### ä»£ç è§£è¯»

å‰é¢æåˆ° `load_bpf_file` å‡½æ•°å°† LLVM ç¼–è¯‘å‡ºæ¥çš„ eBPF å­—èŠ‚ç åŠ è½½è¿›å†…æ ¸ï¼Œè¿™åˆ°åº•æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ

- ç»è¿‡æœæŸ¥ï¼Œå¯ä»¥çœ‹åˆ° `load_bpf_file` ä¹Ÿæ˜¯åœ¨ `samples/bpf` ç›®å½•ä¸‹å®ç°çš„ï¼Œå…·ä½“çš„å‚è§ **`bpf_load.c`**[8]
- é˜…è¯» `load_bpf_file` ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œå®ƒä¸»è¦æ˜¯è§£æ ELF æ ¼å¼çš„ eBPF å­—èŠ‚ç ï¼Œç„¶åè°ƒç”¨ **`load_and_attach`**[9] å‡½æ•°
- åœ¨ `load_and_attach` å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å…¶è°ƒç”¨äº† `bpf_load_program` å‡½æ•°ï¼Œè¿™æ˜¯ libbpf æä¾›çš„å‡½æ•°ã€‚
- è°ƒç”¨çš„ `bpf_load_program` ä¸­çš„ `license`ã€`kern_version` ç­‰å‚æ•°æ¥è‡ªäºè§£æ eBPF ELF æ–‡ä»¶ï¼Œprog_type æ¥è‡ªäº bpf ä»£ç é‡Œé¢ SEC å­—æ®µæŒ‡å®šçš„ç±»å‹ã€‚

```
static int load_and_attach(const char *event, struct bpf_insn *prog, int size)
{
  bool is_socket = strncmp(event, "socket", 6) == 0;
 bool is_kprobe = strncmp(event, "kprobe/", 7) == 0;
 bool is_kretprobe = strncmp(event, "kretprobe/", 10) == 0;
 bool is_tracepoint = strncmp(event, "tracepoint/", 11) == 0;
 bool is_raw_tracepoint = strncmp(event, "raw_tracepoint/", 15) == 0;
 bool is_xdp = strncmp(event, "xdp", 3) == 0;
 bool is_perf_event = strncmp(event, "perf_event", 10) == 0;
 bool is_cgroup_skb = strncmp(event, "cgroup/skb", 10) == 0;
 bool is_cgroup_sk = strncmp(event, "cgroup/sock", 11) == 0;
 bool is_sockops = strncmp(event, "sockops", 7) == 0;
 bool is_sk_skb = strncmp(event, "sk_skb", 6) == 0;
 bool is_sk_msg = strncmp(event, "sk_msg", 6) == 0;

  //...

 fd = bpf_load_program(prog_type, prog, insns_cnt, license, kern_version,
         bpf_log_buf, BPF_LOG_BUF_SIZE);
 if (fd < 0) {
  printf("bpf_load_program() err=%d\n%s", errno, bpf_log_buf);
  return -1;
 }
  //...
}
```

## eBPF ç‰¹æ€§

### Hook Overview

eBPF ç¨‹åºéƒ½æ˜¯äº‹ä»¶é©±åŠ¨çš„ï¼Œå®ƒä»¬ä¼šåœ¨å†…æ ¸æˆ–è€…åº”ç”¨ç¨‹åºç»è¿‡æŸä¸ªç¡®å®šçš„ Hook ç‚¹çš„æ—¶å€™è¿è¡Œï¼Œè¿™äº› Hook ç‚¹éƒ½æ˜¯æå‰å®šä¹‰çš„ï¼ŒåŒ…æ‹¬ç³»ç»Ÿè°ƒç”¨ã€å‡½æ•°è¿›å…¥/é€€å‡ºã€å†…æ ¸ `tracepoints`ã€ç½‘ç»œäº‹ä»¶ç­‰ã€‚

![img](https://996station.com/wp-content/uploads/2022/11/20221126114319155.png?imageView2/0/format/webp/q/75)

å¦‚æœé’ˆå¯¹æŸä¸ªç‰¹å®šéœ€æ±‚çš„ Hook ç‚¹ä¸å­˜åœ¨ï¼Œå¯ä»¥é€šè¿‡ `kprobe` æˆ–è€… `uprobe` æ¥åœ¨å†…æ ¸æˆ–è€…ç”¨æˆ·ç¨‹åºçš„å‡ ä¹æ‰€æœ‰åœ°æ–¹æŒ‚è½½ eBPF ç¨‹åºã€‚

![img](https://996station.com/wp-content/uploads/2022/11/20221126114253887.png?imageView2/0/format/webp/q/75)

### Verification

> With great power there must also come great responsibility.

æ¯ä¸€ä¸ª eBPF ç¨‹åºåŠ è½½åˆ°å†…æ ¸éƒ½è¦ç»è¿‡ `Verification`ï¼Œç”¨æ¥ä¿è¯ eBPF ç¨‹åºçš„å®‰å…¨æ€§ï¼Œä¸»è¦åŒ…æ‹¬ï¼š

- è¦ä¿è¯ åŠ è½½ eBPF ç¨‹åºçš„è¿›ç¨‹æœ‰å¿…è¦çš„ç‰¹æƒçº§ï¼Œé™¤éèŠ‚ç‚¹å¼€å¯äº† 

  ```
  unpriviledged
  ```

   ç‰¹æ€§ï¼Œåªæœ‰ç‰¹æƒçº§çš„ç¨‹åºæ‰èƒ½å¤ŸåŠ è½½ eBPF ç¨‹åº

  - å†…æ ¸æä¾›äº†ä¸€ä¸ªé…ç½®é¡¹ `/proc/sys/kernel/unprivileged_bpf_disabled` æ¥ç¦æ­¢éç‰¹æƒç”¨æˆ·ä½¿ç”¨ `bpf(2)` ç³»ç»Ÿè°ƒç”¨ï¼Œå¯ä»¥é€šè¿‡ `sysctl` å‘½ä»¤ä¿®æ”¹
  - æ¯”è¾ƒç‰¹æ®Šçš„ä¸€ç‚¹æ˜¯ï¼Œè¿™ä¸ªé…ç½®é¡¹ç‰¹æ„è®¾è®¡ä¸º**ä¸€æ¬¡æ€§å¼€å…³**ï¼ˆone-time kill switchï¼‰ï¼Œ è¿™æ„å‘³ç€ä¸€æ—¦å°†å®ƒè®¾ä¸º `1`ï¼Œå°±æ²¡æœ‰åŠæ³•å†æ”¹ä¸º `0` äº†ï¼Œé™¤éé‡å¯å†…æ ¸
  - ä¸€æ—¦è®¾ç½®ä¸º `1` ä¹‹åï¼Œåªæœ‰åˆå§‹å‘½åç©ºé—´ä¸­æœ‰ `CAP_SYS_ADMIN` ç‰¹æƒçš„è¿›ç¨‹æ‰å¯ä»¥è°ƒç”¨ `bpf(2)` ç³»ç»Ÿè°ƒç”¨ ã€‚Cilium å¯åŠ¨åä¹Ÿä¼šå°†è¿™ä¸ªé…ç½®é¡¹è®¾ä¸º 1ï¼š

```
$ echo 1 > /proc/sys/kernel/unprivileged_bpf_disabled
```

- è¦ä¿è¯ eBPF ç¨‹åºä¸ä¼šå´©æºƒæˆ–è€…ä½¿å¾—ç³»ç»Ÿå‡ºæ•…éšœ
- è¦ä¿è¯ eBPF ç¨‹åºä¸èƒ½é™·å…¥æ­»å¾ªç¯ï¼Œèƒ½å¤Ÿ `runs to completion`
- è¦ä¿è¯ eBPF ç¨‹åºå¿…é¡»æ»¡è¶³ç³»ç»Ÿè¦æ±‚çš„å¤§å°ï¼Œè¿‡å¤§çš„ eBPF ç¨‹åºä¸å…è®¸è¢«åŠ è½½è¿›å†…æ ¸
- è¦ä¿è¯ eBPF ç¨‹åºçš„å¤æ‚åº¦æœ‰é™ï¼Œ`Verifier` å°†ä¼šè¯„ä¼° eBPF ç¨‹åºæ‰€æœ‰å¯èƒ½çš„æ‰§è¡Œè·¯å¾„ï¼Œå¿…é¡»èƒ½å¤Ÿåœ¨æœ‰é™æ—¶é—´å†…å®Œæˆ eBPF ç¨‹åºå¤æ‚åº¦åˆ†æ

### JIT Compilation

`Just-In-Time(JIT)` ç¼–è¯‘ç”¨æ¥å°†é€šç”¨çš„ eBPF å­—èŠ‚ç ç¿»è¯‘æˆä¸æœºå™¨ç›¸å…³çš„æŒ‡ä»¤é›†ï¼Œä»è€Œæå¤§åŠ é€Ÿ BPF ç¨‹åºçš„æ‰§è¡Œï¼š

- ä¸è§£é‡Šå™¨ç›¸æ¯”ï¼Œå®ƒä»¬å¯ä»¥é™ä½æ¯ä¸ªæŒ‡ä»¤çš„å¼€é”€ã€‚é€šå¸¸ï¼ŒæŒ‡ä»¤å¯ä»¥ 1:1 æ˜ å°„åˆ°åº•å±‚æ¶æ„çš„åŸç”ŸæŒ‡ä»¤
- è¿™ä¹Ÿä¼šå‡å°‘ç”Ÿæˆçš„å¯æ‰§è¡Œé•œåƒçš„å¤§å°ï¼Œå› æ­¤å¯¹ CPU çš„æŒ‡ä»¤ç¼“å­˜æ›´å‹å¥½
- ç‰¹åˆ«åœ°ï¼Œå¯¹äº CISC æŒ‡ä»¤é›†ï¼ˆä¾‹å¦‚ `x86`ï¼‰ï¼ŒJIT åšäº†å¾ˆå¤šç‰¹æ®Šä¼˜åŒ–ï¼Œç›®çš„æ˜¯ä¸ºç»™å®šçš„æŒ‡ä»¤äº§ç”Ÿå¯èƒ½çš„æœ€çŸ­æ“ä½œç ï¼Œä»¥é™ä½ç¨‹åºç¿»è¯‘è¿‡ç¨‹æ‰€éœ€çš„ç©ºé—´

64 ä½çš„ `x86_64`ã€`arm64`ã€`ppc64`ã€`s390x`ã€`mips64`ã€`sparc64` å’Œ 32 ä½çš„ `arm` ã€`x86_32` æ¶æ„éƒ½å†…ç½®äº† in-kernel eBPF JIT ç¼–è¯‘å™¨ï¼Œå®ƒä»¬çš„åŠŸèƒ½éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå¯ä»¥ç”¨å¦‚ä¸‹æ–¹å¼æ‰“å¼€ï¼š

```
$ echo 1 > /proc/sys/net/core/bpf_jit_enable
```

32 ä½çš„ `mips`ã€`ppc` å’Œ `sparc` æ¶æ„ç›®å‰å†…ç½®çš„æ˜¯ä¸€ä¸ª cBPF JIT ç¼–è¯‘å™¨ã€‚è¿™äº›åªæœ‰ cBPF JIT ç¼–è¯‘å™¨çš„æ¶æ„ï¼Œä»¥åŠé‚£äº›ç”šè‡³å®Œå…¨æ²¡æœ‰ BPF JIT ç¼–è¯‘å™¨çš„æ¶æ„ï¼Œéœ€è¦é€šè¿‡**å†…æ ¸ä¸­çš„è§£é‡Šå™¨**ï¼ˆin-kernel interpreterï¼‰æ‰§è¡Œ eBPF ç¨‹åºã€‚

è¦åˆ¤æ–­å“ªäº›å¹³å°æ”¯æŒ eBPF JITï¼Œå¯ä»¥åœ¨å†…æ ¸æºæ–‡ä»¶ä¸­ grep `HAVE_EBPF_JIT`ï¼š

```
$ git grep HAVE_EBPF_JIT arch/
arch/arm/Kconfig:       select HAVE_EBPF_JIT   if !CPU_ENDIAN_BE32
arch/arm64/Kconfig:     select HAVE_EBPF_JIT
arch/powerpc/Kconfig:   select HAVE_EBPF_JIT   if PPC64
arch/mips/Kconfig:      select HAVE_EBPF_JIT   if (64BIT && !CPU_MICROMIPS)
arch/s390/Kconfig:      select HAVE_EBPF_JIT   if PACK_STACK && HAVE_MARCH_Z196_FEATURES
arch/sparc/Kconfig:     select HAVE_EBPF_JIT   if SPARC64
arch/x86/Kconfig:       select HAVE_EBPF_JIT   if X86_64
```

![img](https://996station.com/wp-content/uploads/2022/11/20221126114242884.png?imageView2/0/format/webp/q/75)

### Maps

BPF Map æ˜¯**é©»ç•™åœ¨å†…æ ¸ç©ºé—´**ä¸­çš„é«˜æ•ˆ `Key/Value store`ï¼ŒåŒ…å«å¤šç§ç±»å‹çš„ Mapï¼Œç”±å†…æ ¸å®ç°å…¶åŠŸèƒ½ï¼Œå…·ä½“å®ç°å¯ä»¥å‚è€ƒ **æˆ‘çš„è¿™ç¯‡åšæ–‡**[10]ã€‚

![img](https://996station.com/wp-content/uploads/2022/11/20221126114234449.png?imageView2/0/format/webp/q/75)

BPF Map çš„äº¤äº’åœºæ™¯æœ‰ä»¥ä¸‹å‡ ç§ï¼š

- BPF ç¨‹åºå’Œç”¨æˆ·æ€ç¨‹åºçš„äº¤äº’ï¼šBPF ç¨‹åºè¿è¡Œå®Œï¼Œå¾—åˆ°çš„ç»“æœå­˜å‚¨åˆ° map ä¸­ï¼Œä¾›ç”¨æˆ·æ€ç¨‹åºé€šè¿‡æ–‡ä»¶æè¿°ç¬¦è®¿é—®
- BPF ç¨‹åºå’Œå†…æ ¸æ€ç¨‹åºçš„äº¤äº’ï¼šå’Œ BPF ç¨‹åºä»¥å¤–çš„å†…æ ¸ç¨‹åºäº¤äº’ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ map ä½œä¸ºä¸­ä»‹
- BPF ç¨‹åºé—´äº¤äº’ï¼šå¦‚æœ BPF ç¨‹åºå†…éƒ¨éœ€è¦ç”¨å…¨å±€å˜é‡æ¥äº¤äº’ï¼Œä½†æ˜¯ç”±äºå®‰å…¨åŸå›  BPF ç¨‹åºä¸å…è®¸è®¿é—®å…¨å±€å˜é‡ï¼Œå¯ä»¥ä½¿ç”¨ map æ¥å……å½“å…¨å±€å˜é‡
- BPF Tail callï¼šTail call æ˜¯ä¸€ä¸ª BPF ç¨‹åºè·³è½¬åˆ°å¦ä¸€ BPF ç¨‹åºï¼ŒBPF ç¨‹åºé¦–å…ˆé€šè¿‡ `BPF_MAP_TYPE_PROG_ARRAY` ç±»å‹çš„ map æ¥çŸ¥é“å¦ä¸€ä¸ª BPF ç¨‹åºçš„æŒ‡é’ˆï¼Œç„¶åè°ƒç”¨ `tail_call()` çš„ helper function æ¥æ‰§è¡Œ Tail call

å…±äº« map çš„ BPF ç¨‹åºä¸è¦æ±‚æ˜¯ç›¸åŒçš„ç¨‹åºç±»å‹ï¼Œä¾‹å¦‚ tracing ç¨‹åºå¯ä»¥å’Œç½‘ç»œç¨‹åºå…±äº« mapï¼Œ**å•ä¸ª BPF ç¨‹åºç›®å‰æœ€å¤šå¯ç›´æ¥è®¿é—® 64 ä¸ªä¸åŒ map**ã€‚

![img](https://996station.com/wp-content/uploads/2022/11/20221126114224530.png?imageView2/0/format/webp/q/75)

å½“å‰å¯ç”¨çš„ **é€šç”¨ map** æœ‰ï¼š

- `BPF_MAP_TYPE_HASH`
- `BPF_MAP_TYPE_ARRAY`
- `BPF_MAP_TYPE_PERCPU_HASH`
- `BPF_MAP_TYPE_PERCPU_ARRAY`
- `BPF_MAP_TYPE_LRU_HASH`
- `BPF_MAP_TYPE_LRU_PERCPU_HASH`
- `BPF_MAP_TYPE_LPM_TRIE`

ä»¥ä¸Š map éƒ½ä½¿ç”¨ç›¸åŒçš„ä¸€ç»„ BPF è¾…åŠ©å‡½æ•°æ¥æ‰§è¡ŒæŸ¥æ‰¾ã€æ›´æ–°æˆ–åˆ é™¤æ“ä½œï¼Œä½†å„è‡ªå®ç°äº†ä¸åŒçš„åç«¯ï¼Œè¿™äº›åç«¯å„æœ‰ä¸åŒçš„è¯­ä¹‰å’Œæ€§èƒ½ç‰¹ç‚¹ã€‚éšç€å¤š CPU æ¶æ„çš„æˆç†Ÿå‘å±•ï¼ŒBPF Map ä¹Ÿå¼•å…¥äº† **per-cpu** ç±»å‹ï¼Œå¦‚`BPF_MAP_TYPE_PERCPU_HASH`ã€`BPF_MAP_TYPE_PERCPU_ARRAY`ç­‰ï¼Œå½“ä½ ä½¿ç”¨è¿™ç§ç±»å‹çš„ BPF Map æ—¶ï¼Œæ¯ä¸ª CPU éƒ½ä¼šå­˜å‚¨å¹¶çœ‹åˆ°å®ƒè‡ªå·±çš„ Map æ•°æ®ï¼Œä»å±äºä¸åŒ CPU ä¹‹é—´çš„æ•°æ®æ˜¯äº’ç›¸éš”ç¦»çš„ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œåœ¨è¿›è¡ŒæŸ¥æ‰¾å’Œèšåˆæ“ä½œæ—¶æ›´åŠ é«˜æ•ˆï¼Œæ€§èƒ½æ›´å¥½ï¼Œå°¤å…¶æ˜¯ä½ çš„ BPF ç¨‹åºä¸»è¦æ˜¯åœ¨åšæ”¶é›†æ—¶é—´åºåˆ—å‹æ•°æ®ï¼Œå¦‚æµé‡æ•°æ®æˆ–æŒ‡æ ‡ç­‰ã€‚

å½“å‰å†…æ ¸ä¸­çš„ **éé€šç”¨ map** æœ‰ï¼š

- `BPF_MAP_TYPE_PROG_ARRAY`ï¼šä¸€ä¸ªæ•°ç»„ mapï¼Œç”¨äº hold å…¶ä»–çš„ BPF ç¨‹åº
- `BPF_MAP_TYPE_PERF_EVENT_ARRAY`
- `BPF_MAP_TYPE_CGROUP_ARRAY`ï¼šç”¨äºæ£€æŸ¥ skb ä¸­çš„ cgroup2 æˆå‘˜ä¿¡æ¯
- `BPF_MAP_TYPE_STACK_TRACE`ï¼šç”¨äºå­˜å‚¨æ ˆè·Ÿè¸ªçš„ MAP
- `BPF_MAP_TYPE_ARRAY_OF_MAPS`ï¼šæŒæœ‰ï¼ˆholdï¼‰ å…¶ä»– map çš„æŒ‡é’ˆï¼Œè¿™æ ·æ•´ä¸ª map å°±å¯ä»¥åœ¨è¿è¡Œæ—¶å®ç°åŸå­æ›¿æ¢
- `BPF_MAP_TYPE_HASH_OF_MAPS`ï¼šæŒæœ‰ï¼ˆholdï¼‰ å…¶ä»– map çš„æŒ‡é’ˆï¼Œè¿™æ ·æ•´ä¸ª map å°±å¯ä»¥åœ¨è¿è¡Œæ—¶å®ç°åŸå­æ›¿æ¢

### Helper Calls

eBPF ç¨‹åºä¸èƒ½å¤Ÿéšæ„è°ƒç”¨å†…æ ¸å‡½æ•°ï¼Œå¦‚æœè¿™ä¹ˆåšçš„è¯ä¼šå¯¼è‡´ eBPF ç¨‹åºä¸ç‰¹å®šçš„å†…æ ¸ç‰ˆæœ¬ç»‘å®šï¼Œç›¸åå®ƒå†…æ ¸å®šä¹‰çš„ä¸€ç³»åˆ— `Helper functions`ã€‚`Helper functions` ä½¿å¾— BPF èƒ½å¤Ÿé€šè¿‡ä¸€ç»„å†…æ ¸å®šä¹‰çš„ç¨³å®šçš„å‡½æ•°è°ƒç”¨æ¥ä»å†…æ ¸ä¸­æŸ¥è¯¢æ•°æ®ï¼Œæˆ–è€…å°†æ•°æ®æ¨é€åˆ°å†…æ ¸ã€‚**æ‰€æœ‰çš„ BPF è¾…åŠ©å‡½æ•°éƒ½æ˜¯æ ¸å¿ƒå†…æ ¸çš„ä¸€éƒ¨åˆ†ï¼Œæ— æ³•é€šè¿‡å†…æ ¸æ¨¡å—æ¥æ‰©å±•æˆ–æ·»åŠ **ã€‚**å½“å‰å¯ç”¨çš„ BPF è¾…åŠ©å‡½æ•°å·²ç»æœ‰å‡ åä¸ªï¼Œå¹¶ä¸”æ•°é‡è¿˜åœ¨ä¸æ–­å¢åŠ **ï¼Œä½ å¯ä»¥åœ¨ **Linux Manual Page: bpf-helpers**[11] çœ‹åˆ°å½“å‰ Linux æ”¯æŒçš„ `Helper functions`ã€‚

![img](https://996station.com/wp-content/uploads/2022/11/20221126114216333.png?imageView2/0/format/webp/q/75)

**ä¸åŒç±»å‹çš„ BPF ç¨‹åºèƒ½å¤Ÿä½¿ç”¨çš„è¾…åŠ©å‡½æ•°å¯èƒ½æ˜¯ä¸åŒçš„**ï¼Œä¾‹å¦‚:

- ä¸ attach åˆ° tc å±‚çš„ BPF ç¨‹åºç›¸æ¯”ï¼Œattach åˆ° socket çš„ BPF ç¨‹åºåªèƒ½å¤Ÿè°ƒç”¨å‰è€…å¯ä»¥è°ƒç”¨çš„è¾…åŠ©å‡½æ•°çš„ä¸€ä¸ªå­é›†
- `lightweight tunneling` ä½¿ç”¨çš„å°è£…å’Œè§£å°è£…è¾…åŠ©å‡½æ•°ï¼Œåªèƒ½è¢«æ›´ä½çš„ tc å±‚ä½¿ç”¨ï¼›è€Œæ¨é€é€šçŸ¥åˆ°ç”¨æˆ·æ€æ‰€ä½¿ç”¨çš„äº‹ä»¶è¾“å‡ºè¾…åŠ©å‡½æ•°ï¼Œæ—¢å¯ä»¥è¢« tc ç¨‹åºä½¿ç”¨ä¹Ÿå¯ä»¥è¢« XDP ç¨‹åºä½¿ç”¨

**æ‰€æœ‰çš„è¾…åŠ©å‡½æ•°éƒ½å…±äº«åŒä¸€ä¸ªé€šç”¨çš„ã€å’Œç³»ç»Ÿè°ƒç”¨ç±»ä¼¼çš„å‡½æ•°æ–¹æ³•**ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š

```
u64 fn(u64 r1, u64 r2, u64 r3, u64 r4, u64 r5)
```

å†…æ ¸å°†è¾…åŠ©å‡½æ•°æŠ½è±¡æˆ `BPF_CALL_0()` åˆ° `BPF_CALL_5()` å‡ ä¸ªå®ï¼Œå½¢å¼å’Œç›¸åº”ç±»å‹çš„ç³»ç»Ÿè°ƒç”¨ç±»ä¼¼ï¼Œè¿™é‡Œå®çš„å®šä¹‰å¯ä»¥å‚è§ **include/linux/filter.h**[12] ã€‚ä»¥ **`bpf_map_update_elem`**[13] ä¸ºä¾‹ï¼Œå¯ä»¥çœ‹åˆ°å®ƒé€šè¿‡è°ƒç”¨ç›¸åº” map çš„å›è°ƒå‡½æ•°å®Œæˆæ›´æ–° map å…ƒç´ çš„æ“ä½œï¼š

```
/* /kernel/bpf/helpers.c */
BPF_CALL_4(bpf_map_update_elem, struct bpf_map *, map, void *, key,
           void *, value, u64, flags)
{
    WARN_ON_ONCE(!rcu_read_lock_held());
    return map->ops->map_update_elem(map, key, value, flags);
}

const struct bpf_func_proto bpf_map_update_elem_proto = {
    .func           = bpf_map_update_elem,
    .gpl_only       = false,
    .ret_type       = RET_INTEGER,
    .arg1_type      = ARG_CONST_MAP_PTR,
    .arg2_type      = ARG_PTR_TO_MAP_KEY,
    .arg3_type      = ARG_PTR_TO_MAP_VALUE,
    .arg4_type      = ARG_ANYTHING,
};
```

è¿™ç§æ–¹å¼æœ‰å¾ˆå¤šä¼˜ç‚¹ï¼š

> è™½ç„¶ cBPF å…è®¸å…¶åŠ è½½æŒ‡ä»¤ï¼ˆload instructionsï¼‰è¿›è¡Œè¶…å‡ºèŒƒå›´çš„è®¿é—®ï¼ˆoverloadï¼‰ï¼Œä»¥ä¾¿ä»ä¸€ä¸ªçœ‹ä¼¼ä¸å¯èƒ½çš„åŒ…åç§»é‡ï¼ˆpacket offsetï¼‰è·å–æ•°æ®ä»¥å”¤é†’å¤šåŠŸèƒ½è¾…åŠ©å‡½æ•°ï¼Œä½†æ¯ä¸ª cBPF JIT ä»ç„¶éœ€è¦ä¸ºè¿™ä¸ª cBPF æ‰©å±•å®ç°å¯¹åº”çš„æ”¯æŒã€‚è€Œåœ¨ eBPF ä¸­ï¼ŒJIT ç¼–è¯‘å™¨ä¼šä»¥ä¸€ç§é€æ˜å’Œé«˜æ•ˆçš„æ–¹å¼ç¼–è¯‘æ–°åŠ å…¥çš„è¾…åŠ©å‡½æ•°ï¼Œè¿™æ„å‘³ç€ JIT ç¼– è¯‘å™¨åªéœ€è¦å‘å°„ï¼ˆemitï¼‰ä¸€æ¡è°ƒç”¨æŒ‡ä»¤ï¼ˆcall instructionï¼‰ï¼Œå› ä¸ºå¯„å­˜å™¨æ˜ å°„çš„æ–¹å¼ä½¿å¾— BPF æ’åˆ—å‚æ•°çš„æ–¹å¼ï¼ˆassignmentsï¼‰å·²ç»å’Œåº•å±‚æ¶æ„çš„è°ƒç”¨çº¦å®šç›¸åŒ¹é…äº†ã€‚è¿™ä½¿å¾—åŸºäºè¾…åŠ©å‡½æ•°æ‰©å±•æ ¸å¿ƒå†…æ ¸ï¼ˆcore kernelï¼‰éå¸¸æ–¹ä¾¿ã€‚**æ‰€æœ‰çš„ BPF è¾…åŠ©å‡½æ•°éƒ½æ˜¯æ ¸å¿ƒå†…æ ¸çš„ä¸€éƒ¨åˆ†ï¼Œæ— æ³•é€šè¿‡å†…æ ¸æ¨¡å—ï¼ˆkernel moduleï¼‰æ¥æ‰©å±•æˆ–æ·»åŠ **ã€‚
>
> å‰é¢æåˆ°çš„å‡½æ•°ç­¾åè¿˜å…è®¸æ ¡éªŒå™¨æ‰§è¡Œç±»å‹æ£€æµ‹ï¼ˆtype checkï¼‰ã€‚ä¸Šé¢çš„ `struct bpf_func_proto` ç”¨äºå­˜æ”¾**æ ¡éªŒå™¨å¿…éœ€çŸ¥é“çš„æ‰€æœ‰å…³äºè¯¥è¾…åŠ©å‡½æ•°çš„ä¿¡æ¯**ï¼Œè¿™ æ ·æ ¡éªŒå™¨å¯ä»¥ç¡®ä¿è¾…åŠ©å‡½æ•°æœŸæœ›çš„ç±»å‹å’Œ BPF ç¨‹åºå¯„å­˜å™¨ä¸­çš„å½“å‰å†…å®¹æ˜¯åŒ¹é…çš„ã€‚
>
> å‚æ•°ç±»å‹èŒƒå›´å¾ˆå¹¿ï¼Œä»ä»»æ„ç±»å‹çš„å€¼ï¼Œåˆ°é™åˆ¶åªèƒ½ä¸ºç‰¹å®šç±»å‹ï¼Œä¾‹å¦‚ BPF æ ˆç¼“å†²åŒºï¼ˆstack bufferï¼‰çš„ `pointer/size` å‚æ•°å¯¹ï¼Œè¾…åŠ©å‡½æ•°å¯ä»¥ä»è¿™ä¸ªä½ç½®è¯»å–æ•°æ®æˆ–å‘å…¶å†™å…¥æ•°æ®ã€‚å¯¹äºè¿™ç§æƒ…å†µï¼Œæ ¡éªŒå™¨è¿˜å¯ä»¥æ‰§è¡Œé¢å¤–çš„æ£€æŸ¥ï¼Œä¾‹å¦‚ï¼Œç¼“å†²åŒºæ˜¯å¦å·²ç»åˆå§‹åŒ–è¿‡äº†ã€‚

### Tail Calls

å°¾è°ƒç”¨çš„æœºåˆ¶æ˜¯æŒ‡ï¼šä¸€ä¸ª BPF ç¨‹åºå¯ä»¥è°ƒç”¨å¦ä¸€ä¸ª BPF ç¨‹åºï¼Œå¹¶ä¸”è°ƒç”¨å®Œæˆåä¸ç”¨è¿”å›åˆ°åŸæ¥çš„ç¨‹åºã€‚

- å’Œæ™®é€šå‡½æ•°è°ƒç”¨ç›¸æ¯”ï¼Œè¿™ç§è°ƒç”¨æ–¹å¼å¼€é”€æœ€å°ï¼Œå› ä¸ºå®ƒæ˜¯**ç”¨é•¿è·³è½¬ï¼ˆlong jumpï¼‰å®ç°çš„ï¼Œå¤ç”¨äº†åŸæ¥çš„æ ˆå¸§** ï¼ˆstack frameï¼‰
- BPF ç¨‹åºéƒ½æ˜¯ç‹¬ç«‹éªŒè¯çš„ï¼Œå› æ­¤è¦ä¼ é€’çŠ¶æ€ï¼Œè¦ä¹ˆä½¿ç”¨ per-CPU map ä½œä¸º scratch ç¼“å†²åŒº ï¼Œè¦ä¹ˆå¦‚æœæ˜¯ tc ç¨‹åºçš„è¯ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ `skb` çš„æŸäº›å­—æ®µï¼ˆä¾‹å¦‚ `cb[]`ï¼‰
- **ç›¸åŒç±»å‹çš„ç¨‹åºæ‰å¯ä»¥å°¾è°ƒç”¨**ï¼Œè€Œä¸”å®ƒä»¬è¿˜è¦ä¸ JIT ç¼–è¯‘å™¨ç›¸åŒ¹é…ï¼Œå› æ­¤è¦ä¹ˆæ˜¯ JIT ç¼–è¯‘æ‰§è¡Œï¼Œè¦ä¹ˆæ˜¯è§£é‡Šå™¨æ‰§è¡Œï¼ˆinvoke interpreted programsï¼‰ï¼Œä½†ä¸èƒ½åŒæ—¶ä½¿ç”¨ä¸¤ç§æ–¹å¼

![img](https://996station.com/wp-content/uploads/2022/11/20221126114141523.png?imageView2/0/format/webp/q/75)

### BPF to BPF Calls

é™¤äº† BPF è¾…åŠ©å‡½æ•°å’Œ BPF å°¾è°ƒç”¨ä¹‹å¤–ï¼ŒBPF æ ¸å¿ƒåŸºç¡€è®¾æ–½æœ€è¿‘åˆšåŠ å…¥äº†ä¸€ä¸ªæ–°ç‰¹æ€§ï¼š`BPF to BPF calls`ã€‚**åœ¨è¿™ä¸ªç‰¹æ€§å¼•å…¥å†…æ ¸ä¹‹å‰ï¼Œå…¸å‹çš„ BPF C ç¨‹åºå¿…é¡» å°†æ‰€æœ‰éœ€è¦å¤ç”¨çš„ä»£ç è¿›è¡Œç‰¹æ®Šå¤„ç†ï¼Œä¾‹å¦‚ï¼Œåœ¨å¤´æ–‡ä»¶ä¸­å£°æ˜ä¸º `always_inline`**ã€‚å½“ LLVM ç¼–è¯‘å’Œç”Ÿæˆ BPF å¯¹è±¡æ–‡ä»¶æ—¶ï¼Œæ‰€æœ‰è¿™äº›å‡½æ•°å°†è¢«å†…è”ï¼Œå› æ­¤ä¼šåœ¨ç”Ÿæˆçš„å¯¹è±¡æ–‡ä»¶ä¸­é‡ å¤å¤šæ¬¡ï¼Œå¯¼è‡´ä»£ç å°ºå¯¸è†¨èƒ€ï¼š

```
#include <linux/bpf.h>

#ifndef __section
# define __section(NAME)                  \
   __attribute__((section(NAME), used))
#endif

#ifndef __inline
# define __inline                         \
   inline __attribute__((always_inline))
#endif

static __inline int foo(void)
{
    return XDP_DROP;
}

__section("prog")
int xdp_drop(struct xdp_md *ctx)
{
    return foo();
}

char __license[] __section("license") = "GPL";
```

ä¹‹æ‰€ä»¥è¦è¿™æ ·åšæ˜¯å› ä¸º **BPF ç¨‹åºçš„åŠ è½½å™¨ã€æ ¡éªŒå™¨ã€è§£é‡Šå™¨å’Œ JIT ä¸­éƒ½ç¼ºå°‘å¯¹å‡½æ•°è°ƒç”¨çš„æ”¯æŒ**ã€‚ä» `Linux 4.16` å’Œ `LLVM 6.0` å¼€å§‹ï¼Œè¿™ä¸ªé™åˆ¶å¾—åˆ°äº†è§£å†³ï¼ŒBPF ç¨‹åºä¸å†éœ€è¦åˆ°å¤„ä½¿ç”¨ `always_inline` å£°æ˜äº†ã€‚å› æ­¤ï¼Œä¸Šé¢çš„ä»£ç å¯ä»¥æ›´è‡ªç„¶åœ°é‡å†™ä¸ºï¼š

```
#include <linux/bpf.h>

#ifndef __section
# define __section(NAME)                  \
   __attribute__((section(NAME), used))
#endif

static int foo(void)
{
    return XDP_DROP;
}

__section("prog")
int xdp_drop(struct xdp_md *ctx)
{
    return foo();
}

char __license[] __section("license") = "GPL";
```

BPF åˆ° BPF è°ƒç”¨æ˜¯ä¸€ä¸ªé‡è¦çš„æ€§èƒ½ä¼˜åŒ–ï¼Œæå¤§å‡å°äº†ç”Ÿæˆçš„ BPF ä»£ç å¤§å°ï¼Œå› æ­¤ **å¯¹ CPU æŒ‡ä»¤ç¼“å­˜ï¼ˆinstruction cacheï¼Œi-cacheï¼‰æ›´å‹å¥½**ã€‚

![img](https://996station.com/wp-content/uploads/2022/11/20221126114130231.png?imageView2/0/format/webp/q/75)

BPF è¾…åŠ©å‡½æ•°çš„è°ƒç”¨çº¦å®šä¹Ÿé€‚ç”¨äº BPF å‡½æ•°é—´è°ƒç”¨ï¼š

- `r1` - `r5` ç”¨äºä¼ é€’å‚æ•°ï¼Œè¿”å›ç»“æœæ”¾åˆ° `r0`
- `r1` - `r5` æ˜¯ scratch registersï¼Œ`r6` - `r9` åƒå¾€å¸¸ä¸€æ ·æ˜¯ä¿ç•™å¯„å­˜å™¨
- æœ€å¤§åµŒå¥—è°ƒç”¨æ·±åº¦æ˜¯ `8`
- è°ƒç”¨æ–¹å¯ä»¥ä¼ é€’æŒ‡é’ˆï¼ˆä¾‹å¦‚ï¼ŒæŒ‡å‘è°ƒç”¨æ–¹çš„æ ˆå¸§çš„æŒ‡é’ˆï¼‰ ç»™è¢«è°ƒç”¨æ–¹ï¼Œä½†åè¿‡æ¥ä¸è¡Œ

**å½“å‰ï¼ŒBPF å‡½æ•°é—´è°ƒç”¨å’Œ BPF å°¾è°ƒç”¨æ˜¯ä¸å…¼å®¹çš„**ï¼Œå› ä¸ºåè€…éœ€è¦å¤ç”¨å½“å‰çš„æ ˆè®¾ç½®ï¼ˆ stack setupï¼‰ï¼Œè€Œå‰è€…ä¼šå¢åŠ ä¸€ä¸ªé¢å¤–çš„æ ˆå¸§ï¼Œå› æ­¤ä¸ç¬¦åˆå°¾è°ƒç”¨æœŸæœ›çš„å¸ƒå±€ã€‚

BPF JIT ç¼–è¯‘å™¨ä¸ºæ¯ä¸ªå‡½æ•°ä½“å‘å°„ç‹¬ç«‹çš„é•œåƒï¼ˆemit separate images for each function bodyï¼‰ï¼Œç¨ååœ¨æœ€åä¸€é€š JIT å¤„ç†ï¼ˆfinal JIT passï¼‰ä¸­å†ä¿®æ”¹é•œåƒä¸­å‡½æ•°è°ƒç”¨çš„åœ°å€ ã€‚å·²ç»è¯æ˜ï¼Œè¿™ç§æ–¹å¼éœ€è¦å¯¹å„ç§ JIT åšæœ€å°‘çš„ä¿®æ”¹ï¼Œå› ä¸ºåœ¨å®ç°ä¸­å®ƒä»¬å¯ä»¥å°† BPF å‡½æ•°é—´è°ƒç”¨å½“åšå¸¸è§„çš„ BPF è¾…åŠ©å‡½æ•°è°ƒç”¨ã€‚

### Object Pinning

**BPF map å’Œç¨‹åºä½œä¸ºå†…æ ¸èµ„æºåªèƒ½é€šè¿‡æ–‡ä»¶æè¿°ç¬¦è®¿é—®ï¼Œå…¶èƒŒåæ˜¯å†…æ ¸ä¸­çš„åŒ¿å inodeã€‚**è¿™å¸¦æ¥äº†å¾ˆå¤šä¼˜ç‚¹ï¼š

- ç”¨æˆ·ç©ºé—´åº”ç”¨ç¨‹åºèƒ½å¤Ÿä½¿ç”¨å¤§éƒ¨åˆ†æ–‡ä»¶æè¿°ç¬¦ç›¸å…³çš„ API
- ä¼ é€’ç»™ Unix socket çš„æ–‡ä»¶æè¿°ç¬¦æ˜¯é€æ˜å·¥ä½œç­‰ç­‰

ä½†åŒæ—¶ï¼Œ**æ–‡ä»¶æè¿°ç¬¦å—é™äºè¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸï¼Œä½¿å¾— map å…±äº«ä¹‹ç±»çš„æ“ä½œéå¸¸ç¬¨é‡**ï¼Œè¿™ç»™æŸäº›ç‰¹å®šçš„åœºæ™¯å¸¦æ¥äº†å¾ˆå¤šå¤æ‚æ€§ã€‚

> ä¾‹å¦‚ iproute2ï¼Œå…¶ä¸­çš„ tc æˆ– XDP åœ¨å‡†å¤‡ç¯å¢ƒã€åŠ è½½ç¨‹åºåˆ°å†…æ ¸ä¹‹åæœ€ç»ˆä¼šé€€å‡ºã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä»ç”¨æˆ·ç©ºé—´ä¹Ÿæ— æ³•è®¿é—®è¿™äº› map äº†ï¼Œè€Œæœ¬æ¥è¿™äº› map å…¶å®æ˜¯å¾ˆæœ‰ç”¨çš„ã€‚ä¾‹å¦‚ï¼Œåœ¨ data path çš„ ingress å’Œ egress ä½ç½®å…±äº«çš„ mapï¼ˆå¯ä»¥ç»Ÿè®¡åŒ…æ•°ã€å­—èŠ‚æ•°ã€PPS ç­‰ä¿¡æ¯ï¼‰ã€‚å¦å¤–ï¼Œç¬¬ä¸‰æ–¹åº”ç”¨å¯èƒ½å¸Œæœ›åœ¨ BPF ç¨‹åºè¿è¡Œæ—¶ç›‘æ§æˆ–æ›´æ–° mapã€‚

**ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå†…æ ¸å®ç°äº†ä¸€ä¸ªæœ€å°å†…æ ¸ç©ºé—´ BPF æ–‡ä»¶ç³»ç»Ÿï¼ŒBPF map å’Œ BPF ç¨‹åº éƒ½å¯ä»¥ pin åˆ°è¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿå†…**ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸º `object pinning`ã€‚BPF ç›¸å…³çš„æ–‡ä»¶ç³»ç»Ÿ**ä¸æ˜¯å•ä¾‹æ¨¡å¼**ï¼ˆsingletonï¼‰ï¼Œå®ƒæ”¯æŒå¤šæŒ‚è½½å®ä¾‹ã€ç¡¬é“¾æ¥ã€è½¯è¿æ¥ç­‰ç­‰ã€‚

ç›¸åº”çš„ï¼ŒBPF ç³»ç»Ÿè°ƒç”¨æ‰©å±•äº†ä¸¤ä¸ªæ–°å‘½ä»¤ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

- `BPF_OBJ_PIN`ï¼šé’‰ä½ä¸€ä¸ªå¯¹è±¡
- `BPF_OBJ_GET`ï¼šè·å–ä¸€ä¸ªè¢«é’‰ä½çš„å¯¹è±¡

![img](https://996station.com/wp-content/uploads/2022/11/20221126114002844.png?imageView2/0/format/webp/q/75)

### Hardening

#### Protection Execution Protection

ä¸ºäº†é¿å…ä»£ç è¢«æŸåï¼ŒBPF ä¼šåœ¨ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸå†…ï¼Œåœ¨å†…æ ¸ä¸­å°† BPF è§£é‡Šå™¨**è§£é‡Šåçš„æ•´ä¸ªé•œåƒ**ï¼ˆ`struct bpf_prog`ï¼‰å’Œ **JIT ç¼–è¯‘ä¹‹åçš„é•œåƒ**ï¼ˆ`struct bpf_binary_header`ï¼‰é”å®šä¸ºåªè¯»çš„ã€‚åœ¨è¿™äº›ä½ç½®å‘ç”Ÿçš„ä»»ä½•æ•°æ®æŸåï¼ˆä¾‹å¦‚ç”±äºæŸäº›å†…æ ¸ bug å¯¼è‡´çš„ï¼‰ä¼šè§¦å‘é€šç”¨çš„ä¿æŠ¤æœºåˆ¶ï¼Œå› æ­¤ä¼šé€ æˆå†…æ ¸å´©æºƒè€Œä¸æ˜¯å…è®¸æŸåé™é»˜åœ°å‘ç”Ÿã€‚

æŸ¥çœ‹å“ªäº›å¹³å°æ”¯æŒå°†é•œåƒå†…å­˜ï¼ˆimage memoryï¼‰è®¾ç½®ä¸ºåªè¯»çš„ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„æœç´¢ï¼š

```
$ git grep ARCH_HAS_SET_MEMORY | grep select
arch/arm/Kconfig:    select ARCH_HAS_SET_MEMORY
arch/arm64/Kconfig:  select ARCH_HAS_SET_MEMORY
arch/s390/Kconfig:   select ARCH_HAS_SET_MEMORY
arch/x86/Kconfig:    select ARCH_HAS_SET_MEMORY
```

`CONFIG_ARCH_HAS_SET_MEMORY` é€‰é¡¹æ˜¯ä¸å¯é…ç½®çš„ï¼Œå› æ­¤å¹³å°è¦ä¹ˆå†…ç½®æ”¯æŒï¼Œè¦ä¹ˆä¸æ”¯æŒï¼Œé‚£äº›ç›®å‰è¿˜ä¸æ”¯æŒçš„æ¶æ„æœªæ¥å¯èƒ½ä¹Ÿä¼šæ”¯æŒã€‚

#### Mitigation Against Spectre

ä¸ºäº†é˜²å¾¡ ![ğŸ‘‰](https://s.w.org/images/core/emoji/14.0.0/svg/1f449.svg)Spectre v2 æ”»å‡»ï¼ŒLinux å†…æ ¸æä¾›äº† `CONFIG_BPF_JIT_ALWAYS_ON` é€‰é¡¹ï¼Œæ‰“å¼€è¿™ä¸ªå¼€å…³å BPF è§£é‡Šå™¨å°†ä¼šä»å†…æ ¸ä¸­å®Œå…¨ç§»é™¤ï¼Œæ°¸è¿œå¯ç”¨ JIT ç¼–è¯‘å™¨ï¼š

- å¦‚æœåº”ç”¨åœ¨ä¸€ä¸ªåŸºäºè™šæ‹Ÿæœºçš„ç¯å¢ƒï¼Œå®¢æˆ·æœºå†…æ ¸å°†ä¸ä¼šå¤ç”¨å†…æ ¸çš„ BPF è§£é‡Šå™¨ï¼Œå› æ­¤å¯ä»¥é¿å…æŸäº›ç›¸å…³çš„æ”»å‡»
- å¦‚æœæ˜¯åŸºäºå®¹å™¨çš„ç¯å¢ƒï¼Œè¿™ä¸ªé…ç½®æ˜¯å¯é€‰çš„ï¼Œå¦‚æœ JIT åŠŸèƒ½æ‰“å¼€äº†ï¼Œè§£é‡Šå™¨ä»ç„¶å¯èƒ½ä¼šåœ¨ç¼–è¯‘æ—¶è¢«å»æ‰ï¼Œä»¥é™ä½å†…æ ¸çš„å¤æ‚åº¦
- å¯¹äºä¸»æµæ¶æ„ï¼ˆä¾‹å¦‚ `x86_64` å’Œ `arm64`ï¼‰ä¸Šçš„ JIT é€šå¸¸éƒ½å»ºè®®æ‰“å¼€è¿™ä¸ªå¼€å…³

å°† `/proc/sys/net/core/bpf_jit_harden` è®¾ç½®ä¸º `1` ä¼šä¸ºéç‰¹æƒç”¨æˆ·çš„ JIT ç¼–è¯‘åšä¸€äº›é¢å¤–çš„åŠ å›ºå·¥ä½œã€‚è¿™äº›é¢å¤–åŠ å›ºä¼šç¨å¾®é™ä½ç¨‹åºçš„æ€§èƒ½ï¼Œä½†åœ¨æœ‰éå—ä¿¡ç”¨æˆ·åœ¨ç³»ç»Ÿä¸Šè¿›è¡Œæ“ä½œçš„æƒ…å†µä¸‹ï¼Œèƒ½å¤Ÿæœ‰æ•ˆåœ°å‡å°æ½œåœ¨çš„å—æ”»å‡»é¢ã€‚ä½†ä¸å®Œå…¨åˆ‡æ¢åˆ°è§£é‡Šå™¨ç›¸æ¯”ï¼Œè¿™äº›æ€§èƒ½æŸå¤±è¿˜æ˜¯æ¯”è¾ƒå°çš„ã€‚å¯¹äº `x86_64` JIT ç¼–è¯‘å™¨ï¼Œå¦‚æœè®¾ç½®äº† `CONFIG_RETPOLINE`ï¼Œå°¾è°ƒç”¨çš„é—´æ¥è·³è½¬ï¼ˆ indirect jumpï¼‰å°±ä¼šç”¨ `retpoline` å®ç°ã€‚å†™ä½œæœ¬æ–‡æ—¶ï¼Œåœ¨å¤§éƒ¨åˆ†ç°ä»£ Linux å‘è¡Œç‰ˆä¸Šè¿™ä¸ªé…ç½®éƒ½æ˜¯æ‰“å¼€çš„ã€‚

#### Constant Blinding

å½“å‰ï¼Œå¯ç”¨åŠ å›ºä¼šåœ¨ JIT ç¼–è¯‘æ—¶**ç›²åŒ–**ï¼ˆblindï¼‰BPF ç¨‹åºä¸­ç”¨æˆ·æä¾›çš„æ‰€æœ‰ 32 ä½å’Œ 64 ä½å¸¸é‡ï¼Œä»¥é˜²å¾¡ **JIT spraying æ”»å‡»**ï¼Œè¿™äº›æ”»å‡»ä¼šå°†åŸç”Ÿæ“ä½œç ä½œä¸ºç«‹å³æ•°æ³¨å…¥åˆ°å†…æ ¸ã€‚è¿™ç§æ”»å‡»æœ‰æ•ˆæ˜¯å› ä¸ºï¼š**ç«‹å³æ•°é©»ç•™åœ¨å¯æ‰§è¡Œå†…æ ¸å†…å­˜ï¼ˆexecutable kernel memoryï¼‰ä¸­**ï¼Œå› æ­¤æŸäº›å†…æ ¸ bug å¯èƒ½ä¼šè§¦å‘ä¸€ä¸ªè·³è½¬åŠ¨ä½œï¼Œå¦‚æœè·³è½¬åˆ°ç«‹å³æ•°çš„å¼€å§‹ä½ç½®ï¼Œå°±ä¼šæŠŠå®ƒä»¬å½“åšåŸç”ŸæŒ‡ä»¤å¼€å§‹æ‰§è¡Œã€‚

ç›²åŒ– JIT å¸¸é‡é€šè¿‡å¯¹çœŸå®æŒ‡ä»¤è¿›è¡ŒéšæœºåŒ–ï¼ˆrandomizing the actual instructionï¼‰å®ç° ã€‚åœ¨è¿™ç§æ–¹å¼ä¸­ï¼Œé€šè¿‡å¯¹æŒ‡ä»¤è¿›è¡Œé‡å†™ï¼Œå°†åŸæ¥**åŸºäºç«‹å³æ•°çš„æ“ä½œ**è½¬æ¢æˆ**åŸºäºå¯„å­˜å™¨çš„æ“ä½œ**ã€‚æŒ‡ä»¤é‡å†™å°†åŠ è½½å€¼çš„è¿‡ç¨‹åˆ†è§£ä¸ºä¸¤éƒ¨åˆ†ï¼š

1. åŠ è½½ä¸€ä¸ªç›²åŒ–åçš„ï¼ˆblindedï¼‰ç«‹å³æ•° `rnd ^ imm` åˆ°å¯„å­˜å™¨
2. å°†å¯„å­˜å™¨å’Œ `rnd` è¿›è¡Œå¼‚æˆ–æ“ä½œï¼ˆxorï¼‰

è¿™æ ·åŸå§‹çš„ `imm` ç«‹å³æ•°å°±é©»ç•™åœ¨å¯„å­˜å™¨ä¸­ï¼Œå¯ä»¥ç”¨äºçœŸå®çš„æ“ä½œäº†ã€‚è¿™é‡Œä»‹ç»çš„åªæ˜¯åŠ è½½æ“ä½œçš„ç›²åŒ–è¿‡ç¨‹ï¼Œå®é™…ä¸Šæ‰€æœ‰çš„é€šç”¨æ“ä½œéƒ½è¢«ç›²åŒ–äº†ã€‚ä¸‹é¢æ˜¯åŠ å›ºå…³é—­çš„æƒ…å†µä¸‹ï¼ŒæŸä¸ªç¨‹åºçš„ JIT ç¼–è¯‘ç»“æœï¼š

```
$ echo 0 > /proc/sys/net/core/bpf_jit_harden

  ffffffffa034f5e9 + <x>:
  [...]
  39:   mov    $0xa8909090,%eax
  3e:   mov    $0xa8909090,%eax
  43:   mov    $0xa8ff3148,%eax
  48:   mov    $0xa89081b4,%eax
  4d:   mov    $0xa8900bb0,%eax
  52:   mov    $0xa810e0c1,%eax
  57:   mov    $0xa8908eb4,%eax
  5c:   mov    $0xa89020b0,%eax
  [...]
```

åŠ å›ºæ‰“å¼€ä¹‹åï¼Œä»¥ä¸Šç¨‹åºè¢«æŸä¸ªéç‰¹æƒç”¨æˆ·é€šè¿‡ BPF åŠ è½½çš„ç»“æœï¼ˆè¿™é‡Œå·²ç»è¿›è¡Œäº†å¸¸é‡ç›²åŒ–ï¼‰ï¼š

```
$ echo 1 > /proc/sys/net/core/bpf_jit_harden

  ffffffffa034f1e5 + <x>:
  [...]
  39:   mov    $0xe1192563,%r10d
  3f:   xor    $0x4989b5f3,%r10d
  46:   mov    %r10d,%eax
  49:   mov    $0xb8296d93,%r10d
  4f:   xor    $0x10b9fd03,%r10d
  56:   mov    %r10d,%eax
  59:   mov    $0x8c381146,%r10d
  5f:   xor    $0x24c7200e,%r10d
  66:   mov    %r10d,%eax
  69:   mov    $0xeb2a830e,%r10d
  6f:   xor    $0x43ba02ba,%r10d
  76:   mov    %r10d,%eax
  79:   mov    $0xd9730af,%r10d
  7f:   xor    $0xa5073b1f,%r10d
  86:   mov    %r10d,%eax
  89:   mov    $0x9a45662b,%r10d
  8f:   xor    $0x325586ea,%r10d
  96:   mov    %r10d,%eax
  [...]
```

ä¸¤ä¸ªç¨‹åºåœ¨è¯­ä¹‰ä¸Šæ˜¯ä¸€æ ·çš„ï¼Œä½†åœ¨ç¬¬äºŒç§æ–¹å¼ä¸­ï¼ŒåŸæ¥çš„ç«‹å³æ•°åœ¨åæ±‡ç¼–ä¹‹åçš„ç¨‹åºä¸­ä¸å†å¯è§ã€‚åŒæ—¶ï¼ŒåŠ å›ºè¿˜ä¼šç¦æ­¢ä»»ä½• JIT å†…æ ¸ç¬¦åˆï¼ˆkallsymsï¼‰æš´éœ²ç»™ç‰¹æƒç”¨æˆ·ï¼ŒJIT é•œåƒåœ°å€ä¸å†å‡ºç°åœ¨ `/proc/kallsyms` ä¸­ã€‚

### Offloads

BPF ç½‘ç»œç¨‹åºï¼Œå°¤å…¶æ˜¯ tc å’Œ XDP BPF ç¨‹åºåœ¨å†…æ ¸ä¸­éƒ½æœ‰ä¸€ä¸ª offload åˆ°ç¡¬ä»¶çš„æ¥å£ï¼Œè¿™æ ·å°±å¯ä»¥ç›´æ¥åœ¨ç½‘å¡ä¸Šæ‰§è¡Œ BPF ç¨‹åºã€‚

å½“å‰ï¼ŒNetronome å…¬å¸çš„ `nfp` é©±åŠ¨æ”¯æŒé€šè¿‡ JIT ç¼–è¯‘å™¨ offload BPFï¼Œå®ƒä¼šå°† BPF æŒ‡ä»¤ç¿»è¯‘æˆç½‘å¡å®ç°çš„æŒ‡ä»¤é›†ã€‚å¦å¤–ï¼Œå®ƒè¿˜æ”¯æŒå°† BPF maps offload åˆ°ç½‘å¡ï¼Œå› æ­¤ offloaded BPF ç¨‹åºå¯ä»¥æ‰§è¡Œ map æŸ¥æ‰¾ã€æ›´æ–°å’Œåˆ é™¤æ“ä½œã€‚

![img](https://996station.com/wp-content/uploads/2022/11/20221126113940930.png?imageView2/0/format/webp/q/75)

## eBPF æ¥å£

### BPF ç³»ç»Ÿè°ƒç”¨

eBPF æä¾›äº† **`bpf()`**[14] ç³»ç»Ÿè°ƒç”¨æ¥å¯¹ BPF Map æˆ– ç¨‹åºè¿›è¡Œæ“ä½œï¼Œå…¶å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š

```
#include <linux/bpf.h>
int bpf(int cmd, union bpf_attr *attr, unsigned int size);
```

å‡½æ•°æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œå…¶ä¸­ï¼š

- `cmd` æŒ‡å®šäº† bpf ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œçš„å‘½ä»¤ç±»å‹ï¼Œæ¯ä¸ª cmd éƒ½ä¼šé™„å¸¦ä¸€ä¸ªå‚æ•° `attr`
- `bpf_attr union` å…è®¸åœ¨å†…æ ¸å’Œç”¨æˆ·ç©ºé—´ä¹‹é—´ä¼ é€’æ•°æ®ï¼Œç¡®åˆ‡çš„æ ¼å¼å–å†³äº `cmd` è¿™ä¸ªå‚æ•°
- `size` è¿™ä¸ªå‚æ•°è¡¨ç¤º`bpf_attr union` è¿™ä¸ªå¯¹è±¡ä»¥å­—èŠ‚ä¸ºå•ä½çš„å¤§å°

`cmd` å¯ä»¥ä¸ºä¸€ä¸‹å‡ ç§ç±»å‹ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥åˆ†ä¸ºæ“ä½œ eBPF Map å’Œæ“ä½œ eBPF ç¨‹åºä¸¤ç§ç±»å‹ï¼š

- `BPF_MAP_CREATE`ï¼šåˆ›å»ºä¸€ä¸ª `eBPF Map` å¹¶ä¸”è¿”å›æŒ‡å‘è¯¥ Map çš„æ–‡ä»¶æè¿°ç¬¦
- `BPF_MAP_LOOKUP_ELEM`ï¼šåœ¨æŸä¸ª Map ä¸­æ ¹æ® key æŸ¥æ‰¾å…ƒç´ å¹¶è¿”å›å…¶ value
- `BPF_MAP_UPDATE_ELEM`ï¼šåœ¨æŸä¸ª Map ä¸­åˆ›å»ºæˆ–è€…æ›´æ–°ä¸€ä¸ªå…ƒç´  key/value å¯¹
- `BPF_MAP_DELETE_ELEM`ï¼šåœ¨æŸä¸ª Map ä¸­æ ¹æ® key åˆ é™¤ä¸€ä¸ªå…ƒç´ 
- `BPF_MAP_GET_NEXT_KEY`ï¼šåœ¨æŸä¸ª Map ä¸­æ ¹æ® key æŸ¥æ‰¾å…ƒç´ ç„¶åè¿”å›ä¸‹ä¸€ä¸ªå…ƒç´ çš„ key
- `BPF_PROG_LOAD`ï¼šæ ¡éªŒå¹¶åŠ è½½ eBPF ç¨‹åºï¼Œè¿”å›ä¸è¯¥ç¨‹åºå…³è”çš„æ–‡ä»¶æè¿°ç¬¦
- â€¦

`bpf_attr union` çš„ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼Œæ ¹æ®ä¸åŒçš„ `cmd` å¯ä»¥å¡«å……ä¸åŒçš„ä¿¡æ¯ã€‚

```
union bpf_attr {
  struct {    /* Used by BPF_MAP_CREATE */
    __u32         map_type;
    __u32         key_size;    /* size of key in bytes */
    __u32         value_size;  /* size of value in bytes */
    __u32         max_entries; /* maximum number of entries in a map */
  };

  struct {    /* Used by BPF_MAP_*_ELEM and BPF_MAP_GET_NEXT_KEY commands */
    __u32         map_fd;
    __aligned_u64 key;
    union {
      __aligned_u64 value;
      __aligned_u64 next_key;
    };
    __u64         flags;
  };

  struct {    /* Used by BPF_PROG_LOAD */
    __u32         prog_type;
    __u32         insn_cnt;
    __aligned_u64 insns;      /* 'const struct bpf_insn *' */
    __aligned_u64 license;    /* 'const char *' */
    __u32         log_level;  /* verbosity level of verifier */
    __u32         log_size;   /* size of user buffer */
    __aligned_u64 log_buf;    /* user supplied 'char *' buffer */
    __u32         kern_version; /* checked when prog_type=kprobe (since Linux 4.1) */
  };
} __attribute__((aligned(8)));
```

#### ä½¿ç”¨ eBPF ç¨‹åºçš„å‘½ä»¤

`BPF_PROG_LOAD` å‘½ä»¤ç”¨äºæ ¡éªŒå’ŒåŠ è½½ eBPF ç¨‹åºï¼Œå…¶éœ€è¦å¡«å……çš„å‚æ•° `bpf_xattr`ï¼Œä¸‹é¢å±•ç¤ºäº†åœ¨ `libbpf` ä¸­ **`bpf_load_program`**[15] çš„å®ç°ï¼Œå¯ä»¥çœ‹åˆ°æœ€ç»ˆæ˜¯è°ƒç”¨äº† `bpf` ç³»ç»Ÿè°ƒç”¨ã€‚

```
/* /tools/lib/bpf/bpf.c */
int bpf_load_program(enum bpf_prog_type type, const struct bpf_insn *insns,
       size_t insns_cnt, const char *license,
       __u32 kern_version, char *log_buf,
       size_t log_buf_sz)
{
 struct bpf_load_program_attr load_attr;

 memset(&load_attr, 0, sizeof(struct bpf_load_program_attr));
 load_attr.prog_type = type;
 load_attr.expected_attach_type = 0;
 load_attr.name = NULL;
 load_attr.insns = insns;
 load_attr.insns_cnt = insns_cnt;
 load_attr.license = license;
 load_attr.kern_version = kern_version;

 return bpf_load_program_xattr(&load_attr, log_buf, log_buf_sz);
}

int bpf_load_program_xattr(const struct bpf_load_program_attr *load_attr,
      char *log_buf, size_t log_buf_sz)
{
  // ...
  fd = sys_bpf_prog_load(&attr, sizeof(attr));
 if (fd >= 0)
  return fd;
  // ...
}

static inline int sys_bpf_prog_load(union bpf_attr *attr, unsigned int size)
{
 int fd;

 do {
  fd = sys_bpf(BPF_PROG_LOAD, attr, size);
 } while (fd < 0 && errno == EAGAIN);

 return fd;
}
```

#### ä½¿ç”¨ eBPF Map çš„å‘½ä»¤

å’Œå‰é¢ä¸€æ ·ï¼ŒæŸ¥çœ‹ `libbpf` ä¸­ **`bpf_create_map`**[16] çš„å®ç°ï¼Œå¯ä»¥çœ‹åˆ°æœ€ç»ˆä¹Ÿè°ƒç”¨äº† bpf ç³»ç»Ÿè°ƒç”¨ï¼š

```
/* /tools/lib/bpf/bpf.c */
int bpf_create_map(enum bpf_map_type map_type, int key_size,
     int value_size, int max_entries, __u32 map_flags)
{
 struct bpf_create_map_attr map_attr = {};

 map_attr.map_type = map_type;
 map_attr.map_flags = map_flags;
 map_attr.key_size = key_size;
 map_attr.value_size = value_size;
 map_attr.max_entries = max_entries;

 return bpf_create_map_xattr(&map_attr);
}

int bpf_create_map_xattr(const struct bpf_create_map_attr *create_attr)
{
 union bpf_attr attr;

 memset(&attr, '\0', sizeof(attr));

 attr.map_type = create_attr->map_type;
 attr.key_size = create_attr->key_size;
 attr.value_size = create_attr->value_size;
 attr.max_entries = create_attr->max_entries;
 attr.map_flags = create_attr->map_flags;
 if (create_attr->name)
  memcpy(attr.map_name, create_attr->name,
         min(strlen(create_attr->name), BPF_OBJ_NAME_LEN - 1));
 attr.numa_node = create_attr->numa_node;
 attr.btf_fd = create_attr->btf_fd;
 attr.btf_key_type_id = create_attr->btf_key_type_id;
 attr.btf_value_type_id = create_attr->btf_value_type_id;
 attr.map_ifindex = create_attr->map_ifindex;
 attr.inner_map_fd = create_attr->inner_map_fd;

 return sys_bpf(BPF_MAP_CREATE, &attr, sizeof(attr));
}
```

`libbpf` ä¸­ **`bpf_map_lookup_elem`**[17] çš„å®ç°ï¼š

```
/* /tools/lib/bpf/bpf.c */
int bpf_map_lookup_elem(int fd, const void *key, void *value)
{
 union bpf_attr attr;

 memset(&attr, 0, sizeof(attr));
 attr.map_fd = fd;
 attr.key = ptr_to_u64(key);
 attr.value = ptr_to_u64(value);

 return sys_bpf(BPF_MAP_LOOKUP_ELEM, &attr, sizeof(attr));
}
```

`libbpf` ä¸­ **`bpf_map_update_elem`**[18] çš„å®ç°ï¼š

```
/* /tools/lib/bpf/bpf.c */
int bpf_map_update_elem(int fd, const void *key, const void *value,
   __u64 flags)
{
 union bpf_attr attr;

 memset(&attr, 0, sizeof(attr));
 attr.map_fd = fd;
 attr.key = ptr_to_u64(key);
 attr.value = ptr_to_u64(value);
 attr.flags = flags;

 return sys_bpf(BPF_MAP_UPDATE_ELEM, &attr, sizeof(attr));
}
```

`libbpf` ä¸­ **`bpf_map_delete_elem`**[19] çš„å®ç°ï¼š

```
/* /tools/lib/bpf/bpf.c */
int bpf_map_delete_elem(int fd, const void *key)
{
 union bpf_attr attr;

 memset(&attr, 0, sizeof(attr));
 attr.map_fd = fd;
 attr.key = ptr_to_u64(key);

 return sys_bpf(BPF_MAP_DELETE_ELEM, &attr, sizeof(attr));
}
```

`libbpf` ä¸­ **`bpf_map_get_next_key`**[20] çš„å®ç°ï¼š

```
/* /tools/lib/bpf/bpf.c */
int bpf_map_get_next_key(int fd, const void *key, void *next_key)
{
 union bpf_attr attr;

 memset(&attr, 0, sizeof(attr));
 attr.map_fd = fd;
 attr.key = ptr_to_u64(key);
 attr.next_key = ptr_to_u64(next_key);

 return sys_bpf(BPF_MAP_GET_NEXT_KEY, &attr, sizeof(attr));
}
```

æ³¨æ„ï¼Œè¿™é‡Œçš„ `libbpf` å‡½æ•°å’Œä¹‹å‰æåˆ°çš„ `helper functions` è¿˜ä¸å¤ªä¸€æ ·ï¼Œä½ å¯ä»¥åœ¨ **Linux Manual Page: bpf-helpers**[21] çœ‹åˆ°å½“å‰ Linux æ”¯æŒçš„ `Helper functions`ã€‚ä»¥ `bpf_map_update_elem` ä¸ºä¾‹ï¼ŒeBPF ç¨‹åºé€šè¿‡è°ƒç”¨ `helper function`ï¼Œå…¶å‚æ•°å¦‚ä¸‹ï¼š

```
struct msg {
 __s32 seq;
 __u64 cts;
 __u8 comm[MAX_LENGTH];
};

struct bpf_map_def SEC("maps") map = {
 .type = BPF_MAP_TYPE_PERF_EVENT_ARRAY,
 .key_size = sizeof(int),
 .value_size = sizeof(__u32),
 .max_entries = 0,
};

void *bpf_map_lookup_elem(struct bpf_map *map, const void *key)
```

è¿™é‡Œçš„ç¬¬ä¸€ä¸ªå‚æ•°æ¥è‡ªäº `SEC(".maps")` è¯­æ³•ç³–åˆ›å»ºçš„ `bpf_map`ã€‚

å¯¹äºç”¨æˆ·æ€ç¨‹åºï¼Œåˆ™å…¶å‡½æ•°åŸå‹å¦‚ä¸‹ï¼Œå…¶ä¸­é€šè¿‡ fd æ¥è®¿é—® eBPF mapã€‚

```
int bpf_map_lookup_elem(int fd, const void *key, void *value)
```

### BPF ç¨‹åºç±»å‹

å‡½æ•°`BPF_PROG_LOAD`åŠ è½½çš„ç¨‹åºç±»å‹è§„å®šäº†å››ä»¶äº‹ï¼š

- ç¨‹åºå¯ä»¥é™„åŠ åœ¨å“ªé‡Œ
- éªŒè¯å™¨å…è®¸è°ƒç”¨å†…æ ¸ä¸­çš„å“ªäº›å¸®åŠ©å‡½æ•°
- ç½‘ç»œåŒ…çš„æ•°æ®æ˜¯å¦å¯ä»¥ç›´æ¥è®¿é—®
- ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’ç»™ç¨‹åºçš„å¯¹è±¡ç±»å‹

å®é™…ä¸Šï¼Œç¨‹åºç±»å‹æœ¬è´¨ä¸Šå®šä¹‰äº†ä¸€ä¸ª APIã€‚ç”šè‡³è¿˜åˆ›å»ºäº†æ–°çš„ç¨‹åºç±»å‹ï¼Œä»¥åŒºåˆ†å…è®¸è°ƒç”¨çš„ä¸åŒçš„å‡½æ•°åˆ—è¡¨ï¼ˆæ¯”å¦‚`BPF_PROG_TYPE_CGROUP_SKB` å¯¹æ¯” `BPF_PROG_TYPE_SOCKET_FILTER`ï¼‰ã€‚

bpf ç¨‹åºä¼šè¢« hook åˆ°å†…æ ¸ä¸åŒçš„ hook ç‚¹ä¸Šã€‚ä¸åŒçš„ hook ç‚¹çš„å…¥å£å‚æ•°ï¼Œèƒ½åŠ›æœ‰æ‰€ä¸åŒã€‚å› è€Œå®šä¹‰äº†ä¸åŒçš„ prog typeã€‚ä¸åŒçš„ prog type çš„ bpf ç¨‹åºèƒ½å¤Ÿè°ƒç”¨çš„ kernel function é›†åˆä¹Ÿä¸ä¸€æ ·ã€‚å½“ bpf ç¨‹åºåŠ è½½åˆ°å†…æ ¸æ—¶ï¼Œå†…æ ¸çš„ verifier ç¨‹åºä¼šæ ¹æ® bpf prog typeï¼Œæ£€æŸ¥ç¨‹åºçš„å…¥å£å‚æ•°ï¼Œè°ƒç”¨äº†å“ªäº› helper functionã€‚

ç›®å‰å†…æ ¸æ”¯æŒçš„ eBPF ç¨‹åºç±»å‹åˆ—è¡¨å¦‚ä¸‹æ‰€ç¤ºï¼š

- `BPF_PROG_TYPE_SOCKET_FILTER`ï¼šä¸€ç§ç½‘ç»œæ•°æ®åŒ…è¿‡æ»¤å™¨
- `BPF_PROG_TYPE_KPROBE`ï¼šç¡®å®š kprobe æ˜¯å¦åº”è¯¥è§¦å‘
- `BPF_PROG_TYPE_SCHED_CLS`ï¼šä¸€ç§ç½‘ç»œæµé‡æ§åˆ¶åˆ†ç±»å™¨
- `BPF_PROG_TYPE_SCHED_ACT`ï¼šä¸€ç§ç½‘ç»œæµé‡æ§åˆ¶åŠ¨ä½œ
- `BPF_PROG_TYPE_TRACEPOINT`ï¼šç¡®å®š tracepoint æ˜¯å¦åº”è¯¥è§¦å‘
- `BPF_PROG_TYPE_XDP`ï¼šä»è®¾å¤‡é©±åŠ¨ç¨‹åºæ¥æ”¶è·¯å¾„è¿è¡Œçš„ç½‘ç»œæ•°æ®åŒ…è¿‡æ»¤å™¨
- `BPF_PROG_TYPE_PERF_EVENT`ï¼šç¡®å®šæ˜¯å¦åº”è¯¥è§¦å‘ perf äº‹ä»¶å¤„ç†ç¨‹åº
- `BPF_PROG_TYPE_CGROUP_SKB`ï¼šä¸€ç§ç”¨äºæ§åˆ¶ç»„çš„ç½‘ç»œæ•°æ®åŒ…è¿‡æ»¤å™¨
- `BPF_PROG_TYPE_CGROUP_SOCK`ï¼šä¸€ç§ç”±äºæ§åˆ¶ç»„çš„ç½‘ç»œåŒ…ç­›é€‰å™¨ï¼Œå®ƒè¢«å…è®¸ä¿®æ”¹å¥—æ¥å­—é€‰é¡¹
- `BPF_PROG_TYPE_LWT_*`ï¼šç”¨äºè½»é‡çº§éš§é“çš„ç½‘ç»œæ•°æ®åŒ…è¿‡æ»¤å™¨
- `BPF_PROG_TYPE_SOCK_OPS`ï¼šä¸€ä¸ªç”¨äºè®¾ç½®å¥—æ¥å­—å‚æ•°çš„ç¨‹åº
- `BPF_PROG_TYPE_SK_SKB`ï¼šä¸€ä¸ªç”¨äºå¥—æ¥å­—ä¹‹é—´è½¬å‘æ•°æ®åŒ…çš„ç½‘ç»œåŒ…è¿‡æ»¤å™¨
- `BPF_PROG_CGROUP_DEVICE`ï¼šç¡®å®šæ˜¯å¦å…è®¸è®¾å¤‡æ“ä½œ

éšç€æ–°ç¨‹åºç±»å‹çš„æ·»åŠ ï¼Œå†…æ ¸å¼€å‘äººå‘˜åŒæ—¶å‘ç°ä¹Ÿéœ€è¦æ·»åŠ æ–°çš„æ•°æ®ç»“æ„ã€‚

ä¸¾ä¸ªä¾‹å­ BPF_PROG_TYPE_SCHED_CLS bpf prog ï¼Œ èƒ½å¤Ÿè®¿é—®å“ªäº› bpf helper function å‘¢ï¼Ÿè®©æˆ‘ä»¬æ¥çœ‹çœ‹æºä»£ç æ˜¯å¦‚ä½•å®ç°çš„ã€‚

æ¯ä¸€ç§ prog type ä¼šå®šä¹‰ä¸€ä¸ª `struct bpf_verifier_ops` ç»“æ„ä½“ã€‚å½“ prog load åˆ°å†…æ ¸æ—¶ï¼Œå†…æ ¸ä¼šæ ¹æ®å®ƒçš„ typeï¼Œè°ƒç”¨ç›¸åº”ç»“æ„ä½“çš„ get_func_proto å‡½æ•°ã€‚

```
const struct bpf_verifier_ops tc_cls_act_verifier_ops = {
        .get_func_proto         = tc_cls_act_func_proto,
    .convert_ctx_access     = tc_cls_act_convert_ctx_access,
};
```

å¯¹äº BPF_PROG_TYPE_SCHED_CLS ç±»å‹çš„ BPF ä»£ç ï¼Œverifier ä¼šè°ƒç”¨ `tc_cls_act_func_proto` ï¼Œä»¥æ£€æŸ¥ç¨‹åºè°ƒç”¨çš„ helper function æ˜¯å¦éƒ½æ˜¯åˆæ³•çš„ã€‚

### BPF ä»£ç è°ƒç”¨æ—¶æœº

æ¯ä¸€ç§ prog type çš„è°ƒç”¨æ—¶æœºéƒ½ä¸åŒã€‚

#### BPF_PROG_TYPE_SCHED_CLS

BPF_PROG_TYPE_SCHED_CLS çš„è°ƒç”¨è¿‡ç¨‹å¦‚ä¸‹ã€‚

##### Egress æ–¹å‘

egress æ–¹å‘ä¸Šï¼Œtcp/ip åè®®æ ˆè¿è¡Œä¹‹åï¼Œæœ‰ä¸€ä¸ª hook ç‚¹ã€‚è¿™ä¸ª hook ç‚¹å¯ä»¥ attach BPF_PROG_TYPE_SCHED_CLS type çš„ egress æ–¹å‘çš„ bpf progã€‚åœ¨è¿™æ®µ bpf ä»£ç æ‰§è¡Œä¹‹åï¼Œæ‰ä¼šè¿è¡Œ qosï¼Œtcpdump, xmit åˆ°ç½‘å¡ driver çš„ä»£ç ã€‚åœ¨è¿™æ®µ bpf ä»£ç ä¸­ä½ å¯ä»¥ä¿®æ”¹æŠ¥æ–‡é‡Œé¢çš„å†…å®¹ï¼Œåœ°å€ç­‰ã€‚ä¿®æ”¹ä¹‹åï¼Œé€šè¿‡ tcpdump å¯ä»¥çœ‹åˆ°ï¼Œå› ä¸º tcpdump ä»£ç åœ¨æ­¤ä¹‹åæ‰æ‰§è¡Œã€‚

```
static int __dev_queue_xmit(struct sk_buff *skb, struct net_device *sb_dev)

{
   skb = sch_handle_egress(skb, &rc, dev);
   // enqueue tc qos
   // dequeue tc qos
   // dev_hard_start_xmit
   // tcpdump works here! dev_queue_xmit_nit
   // nic driver->ndo_start_xmit
}
```

##### Ingress æ–¹å‘

ingress æ–¹å‘ä¸Šï¼Œåœ¨ deliver to tcp/ip åè®®æ ˆä¹‹å‰ï¼Œåœ¨ tcpdump ä¹‹åï¼Œæœ‰ä¸€ä¸ª hook ç‚¹ã€‚è¿™ä¸ª hook ç‚¹å¯ä»¥ attach BPF_PROG_TYPE_SCHED_CLS type çš„ ingress æ–¹å‘çš„ bpf progã€‚åœ¨è¿™é‡Œä½ ä¹Ÿå¯ä»¥ä¿®æ”¹æŠ¥æ–‡ã€‚ä½†æ˜¯ä¿®æ”¹ä¹‹åçš„ç»“æœåœ¨ tcpdump ä¸­æ˜¯çœ‹ä¸åˆ°çš„ã€‚

```
static int __netif_receive_skb_core(struct sk_buff **pskb, bool pfmemalloc,
                                    struct packet_type **ppt_prev)
{
  // generic xdp bpf hook
  // tcpdump
  // tc ingress hook
  skb = sch_handle_ingress(skb, &pt_prev, &ret, orig_dev, &another);
  // deliver to tcp/ip stack or bridge/ipvlan device
}
```

##### æ‰§è¡Œå…¥å£ cls_bpf_classify

æ— è®º egress è¿˜æ˜¯ ingress æ–¹å‘ï¼ŒçœŸæ­£æ‰§è¡Œ bpf æŒ‡ä»¤çš„å…¥å£éƒ½æ˜¯ cls_bpf_classifyã€‚å®ƒéå† tcf_proto ä¸­çš„ bpf prog link listï¼Œ å¯¹æ¯ä¸€ä¸ª bpf prog æ‰§è¡Œ BPF_PROG_RUN(prog->filter, skb)

```
static int cls_bpf_classify(struct sk_buff *skb, const struct tcf_proto *tp,
                            struct tcf_result *res)
{
  struct cls_bpf_head *head = rcu_dereference_bh(tp->root);
  struct cls_bpf_prog *prog;

  list_for_each_entry_rcu(prog, &head->plist, link) {
                int filter_res;
        if (tc_skip_sw(prog->gen_flags)) {
                        filter_res = prog->exts_integrated ? TC_ACT_UNSPEC : 0;
                } else if (at_ingress) {
                        /* It is safe to push/pull even if skb_shared() */
                        __skb_push(skb, skb->mac_len);
                        bpf_compute_data_pointers(skb);
                        filter_res = BPF_PROG_RUN(prog->filter, skb);
                        __skb_pull(skb, skb->mac_len);
                } else {
                        bpf_compute_data_pointers(skb);
                        filter_res = BPF_PROG_RUN(prog->filter, skb);
                }
}
```

BPF_PROG_RUN ä¼šæ‰§è¡Œ JIT compile çš„ bpf æŒ‡ä»¤ï¼Œå¦‚æœå†…æ ¸ä¸æ”¯æŒ JITï¼Œåˆ™ä¼šè°ƒç”¨è§£é‡Šå™¨æ‰§è¡Œ bpf çš„ byte codeã€‚

BPF_PROG_RUN ä¼ ç»™ bpf prog çš„å…¥å£å‚æ•°æ˜¯ skbï¼Œå…¶ç±»å‹æ˜¯ `struct sk_buff`, å®šä¹‰åœ¨æ–‡ä»¶ include/linux/skbuff.h ä¸­ã€‚

ä½†æ˜¯åœ¨ bpf ä»£ç ä¸­ï¼Œä¸ºäº†å®‰å…¨ï¼Œä¸èƒ½ç›´æ¥è®¿é—® `sk_buff`ã€‚bpf ä¸­æ˜¯é€šè¿‡è®¿é—® `struct __sk_buff` æ¥è®¿é—® struct sk_buff çš„ã€‚`__sk_buff` æ˜¯ `sk_buff` çš„ä¸€ä¸ªå­é›†ï¼Œæ˜¯ sk_buff é¢å‘ bpf ç¨‹åºçš„æ¥å£ã€‚bpf ä»£ç ä¸­å¯¹ `__sk_buff` çš„è®¿é—®ä¼šåœ¨ verifier ç¨‹åºä¸­ç¿»è¯‘æˆå¯¹ sk_buff ç›¸åº” fileds çš„è®¿é—®ã€‚

åœ¨åŠ è½½ bpf prog çš„æ—¶å€™ï¼Œverifier ä¼šè°ƒç”¨ä¸Šé¢ `tc_cls_act_verifier_ops` ç»“æ„ä½“é‡Œé¢çš„ tc_cls_act_convert_ctx_access çš„é’©å­ã€‚å®ƒæœ€ç»ˆä¼šè°ƒç”¨ä¸‹é¢çš„å‡½æ•°ä¿®æ”¹ ebpf çš„æŒ‡ä»¤ï¼Œä½¿å¾—å¯¹ `__sk_buff` çš„è®¿é—®å˜æˆå¯¹ `struct sk_buff` çš„è®¿é—®ã€‚

### BPF Attach type

ä¸€ç§ type çš„ bpf prog å¯ä»¥æŒ‚åˆ°å†…æ ¸ä¸­ä¸åŒçš„ hook ç‚¹ï¼Œè¿™äº›ä¸åŒçš„ hook ç‚¹å°±æ˜¯ä¸åŒçš„ attach typeã€‚

å…¶å¯¹åº”å…³ç³»åœ¨ **ä¸‹é¢å‡½æ•°**[22] ä¸­å®šä¹‰äº†ã€‚

```
attach_type_to_prog_type(enum bpf_attach_type attach_type)
{
        switch (attach_type) {
        case BPF_CGROUP_INET_INGRESS:
        case BPF_CGROUP_INET_EGRESS:
                return BPF_PROG_TYPE_CGROUP_SKB;
        case BPF_CGROUP_INET_SOCK_CREATE:
        case BPF_CGROUP_INET_SOCK_RELEASE:
        case BPF_CGROUP_INET4_POST_BIND:
        case BPF_CGROUP_INET6_POST_BIND:
                return BPF_PROG_TYPE_CGROUP_SOCK;
     .....
}
```

å½“ bpf prog é€šè¿‡ç³»ç»Ÿè°ƒç”¨ bpf() attach åˆ°å…·ä½“çš„ hook ç‚¹æ—¶ï¼Œå…¶å…¥å£å‚æ•°ä¸­å°±éœ€è¦æŒ‡å®š attach typeã€‚

æœ‰è¶£çš„æ˜¯ï¼ŒBPF_PROG_TYPE_SCHED_CLS ç±»å‹çš„ bpf prog ä¸èƒ½é€šè¿‡ bpf ç³»ç»Ÿè°ƒç”¨æ¥ attachï¼Œå› ä¸ºå®ƒæ²¡æœ‰å®šä¹‰å¯¹åº”çš„ attach typeã€‚æ•…å®ƒçš„ attach éœ€è¦é€šè¿‡ netlink interface é¢å¤–çš„å®ç°ï¼Œè¿˜æ˜¯éå¸¸å¤æ‚çš„ã€‚

### å¸¸ç”¨ prog type ä»‹ç»

å†…æ ¸ä¸­çš„ prog type ç›®å‰æœ‰ 30 ç§ã€‚æ¯ä¸€ç§ type èƒ½åšçš„äº‹æƒ…æœ‰æ‰€å·®å¼‚ï¼Œè¿™é‡Œåªè®²è®²æˆ‘å¹³æ—¶å·¥ä½œç”¨è¿‡çš„å‡ ç§ã€‚

ç†è§£ä¸€ç§ prog type çš„æœ€å¥½çš„æ–¹æ³•æ˜¯

- æŸ¥è¡¨ attach_type_to_prog_typeï¼Œå¾—åˆ°å®ƒçš„ attach typeï¼Œ
- å†æœç´¢å†…æ ¸ä»£ç ï¼Œçœ‹è¿™äº› attach type åœ¨å†…æ ¸å“ªé‡Œè¢«è°ƒç”¨äº†ã€‚
- æœ€åçœ‹çœ‹å®ƒçš„å…¥å£å‚æ•°å’Œ return value çš„å¤„ç†è¿‡ç¨‹ï¼ŒåŸºæœ¬å°±èƒ½ç†è§£å…¶ä½œç”¨äº†ã€‚

```
include/uapi/linux/bpf.h

enum bpf_prog_type {
}
```

#### BPF_PROG_TYPE_SOCKET_FILTER

æ˜¯ç¬¬ä¸€ä¸ªè¢«æ·»åŠ åˆ°å†…æ ¸çš„ç¨‹åºç±»å‹ã€‚å½“ä½  attach ä¸€ä¸ª bpf ç¨‹åºåˆ° socket ä¸Šï¼Œä½ å¯ä»¥è·å–åˆ°è¢« socket å¤„ç†çš„æ‰€æœ‰æ•°æ®åŒ…ã€‚socket è¿‡æ»¤ä¸å…è®¸ä½ ä¿®æ”¹è¿™äº›æ•°æ®åŒ…ä»¥åŠè¿™äº›æ•°æ®åŒ…çš„ç›®çš„åœ°ã€‚ä»…ä»…æ˜¯æä¾›ç»™ä½ è§‚å¯Ÿè¿™äº›æ•°æ®åŒ…ã€‚åœ¨ä½ çš„ç¨‹åºä¸­å¯ä»¥è·å–åˆ°è¯¸å¦‚ protocol type ç±»å‹ç­‰ã€‚

ä»¥ tcp ä¸º exampleï¼Œè°ƒç”¨çš„åœ°ç‚¹æ˜¯ tcp_v4_rcv->tcp_filter->sk_filter_trim_cap ä½œç”¨æ˜¯è¿‡æ»¤æŠ¥æ–‡ï¼Œæˆ–è€… trim æŠ¥æ–‡ã€‚udp, icmp ä¸­ä¹Ÿæœ‰ç›¸å…³çš„è°ƒç”¨ã€‚

#### BPF_PROG_TYPE_SOCK_OPS

åœ¨ tcp åè®® event å‘ç”Ÿæ—¶è°ƒç”¨çš„ bpf é’©å­ï¼Œå®šä¹‰äº† 15 ç§ eventã€‚è¿™äº› event çš„ attach type éƒ½æ˜¯ BPF_CGROUP_SOCK_OPSã€‚ä¸åŒçš„è°ƒç”¨ç‚¹ä¼šä¼ å…¥ä¸åŒçš„ enum, æ¯”å¦‚ï¼š

- BPF_SOCK_OPS_TCP_CONNECT_CB æ˜¯ä¸»åŠ¨ tcp connect call çš„ï¼›
- BPF_SOCK_OPS_ACTIVE_ESTABLISHED_CB æ˜¯è¢«åŠ¨ connect æˆåŠŸæ—¶è°ƒç”¨çš„ã€‚

ä¸»è¦ä½œç”¨ï¼štcp è°ƒä¼˜ï¼Œevent ç»Ÿè®¡ç­‰ã€‚

BPF_PROG_TYPE_SOCK_OPS è¿™ç§ç¨‹åºç±»å‹ï¼Œå…è®¸ä½ å½“æ•°æ®åŒ…åœ¨å†…æ ¸ç½‘ç»œåè®®æ ˆçš„å„ä¸ªé˜¶æ®µä¼ è¾“çš„æ—¶å€™ï¼Œå»ä¿®æ”¹å¥—æ¥å­—çš„é“¾æ¥é€‰é¡¹ã€‚ä»–ä»¬ attach åˆ° cgroups ä¸Šï¼Œå’Œ BPF_PROG_TYPE_CGROUP_SOCK ä»¥åŠ BPF_PROG_TYPE_CGROUP_SKB å¾ˆåƒï¼Œä½†æ˜¯ä¸åŒçš„æ˜¯ï¼Œä»–ä»¬å¯ä»¥åœ¨æ•´ä¸ªè¿æ¥çš„ç”Ÿå‘½å‘¨æœŸå†…è¢«è°ƒç”¨å¥½å¤šæ¬¡ã€‚ä½ çš„ bpf ç¨‹åºä¼šæ¥å—åˆ°ä¸€ä¸ª op çš„å‚æ•°ï¼Œè¯¥å‚æ•°ä»£è¡¨å†…æ ¸å°†é€šè¿‡å¥—æ¥å­—é“¾æ¥æ‰§è¡Œçš„æ“ä½œã€‚å› æ­¤ï¼Œä½ çŸ¥é“åœ¨é“¾æ¥çš„ç”Ÿå‘½å‘¨æœŸå†…ä½•æ—¶è°ƒç”¨è¯¥ç¨‹åºã€‚å¦ä¸€æ–¹é¢ï¼Œä½ å¯ä»¥è·å– ip åœ°å€ï¼Œç«¯å£ç­‰ã€‚ä½ è¿˜å¯ä»¥ä¿®æ”¹é“¾æ¥çš„é“¾æ¥çš„é€‰é¡¹ä»¥è®¾ç½®è¶…æ—¶å¹¶æ›´æ”¹æ•°æ®åŒ…çš„å¾€è¿”å»¶è¿Ÿæ—¶é—´ã€‚

ä¸¾ä¸ªä¾‹å­ï¼ŒFacebook ä½¿ç”¨å®ƒæ¥ä¸ºåŒä¸€æ•°æ®ä¸­å¿ƒå†…çš„è¿æ¥è®¾ç½®çŸ­æ¢å¤æ—¶é—´ç›®æ ‡ï¼ˆRTOï¼‰ã€‚RTO æ˜¯ä¸€ç§æ—¶é—´ï¼Œå®ƒæŒ‡çš„æ˜¯ç½‘ç»œåœ¨å‡ºç°æ•…éšœåçš„æ¢å¤æ—¶é—´ï¼Œè¿™ä¸ªæŒ‡æ ‡ä¹Ÿè¡¨ç¤ºç½‘ç»œåœ¨å—åˆ°ä¸å¯æ¥å—åˆ°æƒ…å†µä¸‹çš„ï¼Œä¸èƒ½è¢«ä½¿ç”¨çš„æ—¶é—´ã€‚Facebook è®¤ä¸ºï¼Œåœ¨åŒä¸€æ•°æ®ä¸­å¿ƒä¸­ï¼Œåº”è¯¥æœ‰ä¸€ä¸ªå¾ˆçŸ­çš„ RTO,Facebook ä¿®æ”¹äº†è¿™ä¸ªæ—¶é—´ï¼Œä½¿ç”¨ bpf ç¨‹åºã€‚

#### BPF_PROG_TYPE_CGROUP_SOCK_ADDR

å®ƒå¯¹åº”å¾ˆå¤š attach typeï¼Œä¸€èˆ¬åœ¨ bind, connect æ—¶è°ƒç”¨, ä¼ å…¥ sock çš„åœ°å€ã€‚

ä¸»è¦ä½œç”¨ï¼šä¾‹å¦‚ cilium ä¸­ clusterip çš„å®ç°ï¼Œåœ¨ä¸»åŠ¨ connect æ—¶ï¼Œä¿®æ”¹äº†ç›®çš„ ip åœ°å€ï¼Œå°±æ˜¯åˆ©ç”¨è¿™ä¸ªã€‚

BPF_PROG_TYPE_CGROUP_SOCK_ADDRï¼Œè¿™ç§ç±»å‹çš„ç¨‹åºä½¿æ‚¨å¯ä»¥åœ¨ç”±ç‰¹å®š cgroup æ§åˆ¶çš„ç”¨æˆ·ç©ºé—´ç¨‹åºä¸­æ“çºµ IP åœ°å€å’Œç«¯å£å·ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå½“æ‚¨è¦ç¡®ä¿ä¸€ç»„ç‰¹å®šçš„ç”¨æˆ·ç©ºé—´ç¨‹åºä½¿ç”¨ç›¸åŒçš„ IP åœ°å€å’Œç«¯å£æ—¶ï¼Œç³»ç»Ÿå°†ä½¿ç”¨å¤šä¸ª IP åœ°å€.å½“æ‚¨å°†è¿™äº›ç”¨æˆ·ç©ºé—´ç¨‹åºæ”¾åœ¨åŒä¸€ cgroup ä¸­æ—¶ï¼Œè¿™äº› BPF ç¨‹åºä½¿æ‚¨å¯ä»¥çµæ´»åœ°æ“ä½œè¿™äº›ç»‘å®šã€‚è¿™æ ·å¯ä»¥ç¡®ä¿è¿™äº›åº”ç”¨ç¨‹åºçš„æ‰€æœ‰ä¼ å…¥å’Œä¼ å‡ºè¿æ¥å‡ä½¿ç”¨ BPF ç¨‹åºæä¾›çš„ IP å’Œç«¯å£ã€‚

#### BPF_PROG_TYPE_SK_MSG

BPF_PROG_TYPE_SK_MSGï¼Œ These types of programs let you control whether a message sent to a socket should be delivered.å½“å†…æ ¸åˆ›å»ºäº†ä¸€ä¸ª socketï¼Œå®ƒä¼šè¢«å­˜å‚¨åœ¨å‰é¢æåˆ°çš„ map ä¸­ã€‚å½“ä½  attach ä¸€ä¸ªç¨‹åºåˆ°è¿™ä¸ª socket map çš„æ—¶å€™ï¼Œæ‰€æœ‰çš„è¢«å‘é€åˆ°é‚£äº› socket çš„ message éƒ½ä¼šè¢« filterã€‚åœ¨ filter message ä¹‹å‰ï¼Œå†…æ ¸æ‹·è´äº†è¿™äº› dataï¼Œå› æ­¤ä½ å¯ä»¥è¯»å–è¿™äº› messageï¼Œè€Œä¸”å¯ä»¥ç»™å‡ºä½ çš„å†³å®šï¼šä¾‹å¦‚ï¼ŒSK_PASS å’Œ SK_DROPã€‚

#### BPF_PROG_TYPE_SK_SKB

è°ƒç”¨ç‚¹ï¼štcp sendmsg æ—¶ä¼šè°ƒç”¨ã€‚

ä¸»è¦ä½œç”¨ï¼šåš sock redir ç”¨çš„ã€‚

BPF_PROG_TYPE_SK_SKBï¼Œè¿™ç±»ç¨‹åºå¯ä»¥è®©ä½ è·å– socket maps å’Œ socket redirectsã€‚socket maps å¯ä»¥è®©ä½ è·å¾—ä¸€äº› socket çš„å¼•ç”¨ã€‚å½“ä½ æœ‰äº†è¿™äº›å¼•ç”¨ï¼Œä½ å¯ä»¥ä½¿ç”¨ç›¸å…³çš„ helpersï¼Œå»é‡å®šå‘ä¸€ä¸ª incoming çš„ packet ï¼Œä»ä¸€ä¸ª socket å»å¦å¤–ä¸€ä¸ª scoket.è¿™åœ¨ä½¿ç”¨ BPF æ¥åšè´Ÿè½½å‡è¡¡æ—¶æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚ä½ å¯ä»¥åœ¨ socket ä¹‹é—´è½¬å‘ç½‘ç»œæ•°æ®åŒ…ï¼Œè€Œä¸éœ€è¦ç¦»å¼€å†…æ ¸ç©ºé—´ã€‚Cillium å’Œ facebook çš„ Katran å¹¿æ³›çš„ä½¿ç”¨è¿™ç§ç±»å‹çš„ç¨‹åºå»åšæµé‡æ§åˆ¶ã€‚

#### BPF_PROG_TYPE_CGROUP_SOCKOPT

è°ƒç”¨ç‚¹ï¼šgetsockopt, setsockopt

#### BPF_PROG_TYPE_KPROBE

ç±»ä¼¼ ftrace çš„ kprobeï¼Œåœ¨å‡½æ•°å‡ºå…¥å£çš„ hook ç‚¹ï¼Œdebug ç”¨çš„ã€‚

#### BPF_PROG_TYPE_TRACEPOINT

ç±»ä¼¼ ftrace çš„ tracepointã€‚

#### BPF_PROG_TYPE_SCHED_CLS

å¦‚ä¸Šé¢çš„ä¾‹å­

#### BPF_PROG_TYPE_XDP

ç½‘å¡é©±åŠ¨æ”¶åˆ° packet æ—¶ï¼Œå°šæœªç”Ÿæˆ sk_buff æ•°æ®ç»“æ„ä¹‹å‰çš„ä¸€ä¸ª hook ç‚¹ã€‚

BPF_PROG_TYPE_XDP å…è®¸ä½ çš„ bpf ç¨‹åºï¼Œåœ¨ç½‘ç»œæ•°æ®åŒ…åˆ°è¾¾ kernel å¾ˆæ—©çš„æ—¶å€™ã€‚åœ¨è¿™æ ·çš„ bpf ç¨‹åºä¸­ï¼Œä½ ä»…ä»…å¯èƒ½è·å–åˆ°ä¸€ç‚¹ç‚¹çš„ä¿¡æ¯ï¼Œå› ä¸º kernel è¿˜æ²¡æœ‰è¶³å¤Ÿçš„æ—¶é—´å»å¤„ç†ã€‚å› ä¸ºæ—¶é—´è¶³å¤Ÿçš„æ—©ï¼Œæ‰€ä»¥ä½ å¯ä»¥åœ¨ç½‘ç»œå¾ˆé«˜çš„å±‚é¢ä¸Šå»å¤„ç†è¿™äº› packetã€‚

XDP å®šä¹‰äº†å¾ˆå¤šçš„å¤„ç†æ–¹å¼ï¼Œä¾‹å¦‚

- XDP_PASS å°±æ„å‘³ç€ï¼Œä½ ä¼šæŠŠ packet äº¤ç»™å†…æ ¸çš„å¦ä¸€ä¸ªå­ç³»ç»Ÿå»å¤„ç†
- XDP_DROP å°±æ„å‘³ç€ï¼Œå†…æ ¸åº”è¯¥ä¸¢å¼ƒè¿™ä¸ªæ•°æ®åŒ…
- XDP_TX æ„å‘³ç€ï¼Œä½ å¯ä»¥æŠŠè¿™ä¸ªåŒ…è½¬å‘åˆ° network interface card(NIC)ç¬¬ä¸€æ¬¡æ¥æ”¶åˆ°è¿™ä¸ªåŒ…çš„æ—¶å€™

#### BPF_PROG_TYPE_CGROUP_SKB

BPF_PROG_TYPE_CGROUP_SKB å…è®¸ä½ è¿‡æ»¤æ•´ä¸ª cgroup çš„ç½‘ç»œæµé‡ã€‚åœ¨è¿™ç§ç¨‹åºç±»å‹ä¸­ï¼Œä½ å¯ä»¥åœ¨ç½‘ç»œæµé‡åˆ°è¾¾è¿™ä¸ª cgoup ä¸­çš„ç¨‹åºå‰åšä¸€äº›æ§åˆ¶ã€‚å†…æ ¸è¯•å›¾ä¼ é€’ç»™åŒä¸€ cgroup ä¸­ä»»ä½•è¿›ç¨‹çš„ä»»ä½•æ•°æ®åŒ…éƒ½å°†é€šè¿‡è¿™äº›è¿‡æ»¤å™¨ä¹‹ä¸€ã€‚åŒæ—¶ï¼Œæ‚¨å¯ä»¥å†³å®š cgroup ä¸­çš„è¿›ç¨‹é€šè¿‡è¯¥æ¥å£å‘é€ç½‘ç»œæ•°æ®åŒ…æ—¶è¯¥æ€ä¹ˆåšã€‚å…¶å®ï¼Œä½ å¯ä»¥å‘ç°å®ƒå’Œ BPF_PROG_TYPE_SOCKET_FILTER çš„ç±»å‹å¾ˆç±»ä¼¼ã€‚æœ€å¤§çš„ä¸åŒæ˜¯ cgroup_skb æ˜¯ attach åˆ°è¿™ä¸ª cgroup ä¸­çš„æ‰€æœ‰è¿›ç¨‹ï¼Œè€Œä¸æ˜¯ç‰¹æ®Šçš„è¿›ç¨‹ã€‚åœ¨ container çš„ç¯å¢ƒä¸­ï¼Œbpf æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚

- ingress æ–¹å‘ä¸Šï¼Œtcp æ”¶åˆ°æŠ¥æ–‡æ—¶ï¼ˆtcp_v4_rcvï¼‰ï¼Œä¼šè°ƒç”¨è¿™ä¸ª bpf åšè¿‡æ»¤ã€‚
- egress æ–¹å‘ä¸Šï¼Œip åœ¨å‡ºæŠ¥æ–‡æ—¶ï¼ˆip_finish_outputï¼‰ä¼šè°ƒç”¨å®ƒåšä¸¢åŒ…è¿‡æ»¤ è¾“å…¥å‚æ•°æ˜¯ skbã€‚

#### BPF_PROG_TYPE_CGROUP_SOCK

åœ¨ sock create, release, post_bind æ—¶è°ƒç”¨çš„ã€‚ä¸»è¦ç”¨æ¥åšä¸€äº›æƒé™æ£€æŸ¥çš„ã€‚

BPF_PROG_TYPE_CGROUP_SOCKï¼Œè¿™ç§ç±»å‹çš„ bpf ç¨‹åºå…è®¸ä½ ï¼Œåœ¨ä¸€ä¸ª cgroup ä¸­çš„ä»»ä½•è¿›ç¨‹æ‰“å¼€ä¸€ä¸ª socket çš„æ—¶å€™ï¼Œå»æ‰§è¡Œä½ çš„ Bpf ç¨‹åºã€‚è¿™ä¸ªè¡Œä¸ºå’Œ CGROUP_SKB çš„è¡Œä¸ºç±»ä¼¼ï¼Œä½†æ˜¯å®ƒæ˜¯æä¾›ç»™ä½  cgoup ä¸­çš„è¿›ç¨‹æ‰“å¼€ä¸€ä¸ªæ–°çš„ socket çš„æ—¶å€™çš„æƒ…å†µï¼Œè€Œä¸æ˜¯ç»™ä½ ç½‘ç»œæ•°æ®åŒ…é€šè¿‡çš„æƒé™æ§åˆ¶ã€‚è¿™å¯¹äºä¸ºå¯ä»¥æ‰“å¼€å¥—æ¥å­—çš„ç¨‹åºç»„æä¾›å®‰å…¨æ€§å’Œè®¿é—®æ§åˆ¶å¾ˆæœ‰ç”¨ï¼Œè€Œä¸å¿…åˆ†åˆ«é™åˆ¶æ¯ä¸ªè¿›ç¨‹çš„åŠŸèƒ½ã€‚

## eBPF å·¥å…·é“¾

### bcc

BCC æ˜¯ BPF çš„ç¼–è¯‘å·¥å…·é›†åˆï¼Œå‰ç«¯æä¾› Python/Lua APIï¼Œæœ¬èº«é€šè¿‡ C/C++ è¯­è¨€å®ç°ï¼Œé›†æˆ LLVM/Clang å¯¹ BPF ç¨‹åºè¿›è¡Œé‡å†™ã€ç¼–è¯‘å’ŒåŠ è½½ç­‰åŠŸèƒ½ï¼Œ æä¾›ä¸€äº›æ›´äººæ€§åŒ–çš„å‡½æ•°ç»™ç”¨æˆ·ä½¿ç”¨ã€‚

è™½ç„¶ BCC ç«­å°½å…¨åŠ›åœ°ç®€åŒ– BPF ç¨‹åºå¼€å‘äººå‘˜çš„å·¥ä½œï¼Œä½†å…¶â€œé»‘é­”æ³•â€ ï¼ˆä½¿ç”¨ Clang å‰ç«¯ä¿®æ”¹äº†ç”¨æˆ·ç¼–å†™çš„ BPF ç¨‹åºï¼‰ä½¿å¾—å‡ºç°é—®é¢˜æ—¶ï¼Œå¾ˆéš¾æ‰¾åˆ°é—®é¢˜çš„æ‰€åœ¨ä»¥åŠè§£å†³æ–¹æ³•ã€‚å¿…é¡»è®°ä½å‘½åçº¦å®šå’Œè‡ªåŠ¨ç”Ÿæˆçš„è·Ÿè¸ªç‚¹ç»“æ„ ã€‚ä¸”ç”±äº libbcc åº“å†…éƒ¨é›†æˆäº†åºå¤§çš„ LLVM/Clang åº“ï¼Œä½¿å…¶åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ä¼šé‡åˆ°ä¸€äº›é—®é¢˜ï¼š

1. åœ¨æ¯ä¸ªå·¥å…·å¯åŠ¨æ—¶ï¼Œéƒ½ä¼šå ç”¨è¾ƒé«˜çš„ CPU å’Œå†…å­˜èµ„æºæ¥ç¼–è¯‘ BPF ç¨‹åºï¼Œåœ¨ç³»ç»Ÿèµ„æºå·²ç»çŸ­ç¼ºçš„æœåŠ¡å™¨ä¸Šè¿è¡Œå¯èƒ½å¼•èµ·é—®é¢˜ï¼›
2. ä¾èµ–äºå†…æ ¸å¤´æ–‡ä»¶åŒ…ï¼Œå¿…é¡»å°†å…¶å®‰è£…åœ¨æ¯ä¸ªç›®æ ‡ä¸»æœºä¸Šã€‚å³ä¾¿å¦‚æ­¤ï¼Œå¦‚æœéœ€è¦å†…æ ¸ä¸­æœª export çš„å†…å®¹ï¼Œåˆ™éœ€è¦æ‰‹åŠ¨å°†ç±»å‹å®šä¹‰å¤åˆ¶/ç²˜è´´åˆ° BPF ä»£ç ä¸­ï¼›
3. ç”±äº BPF ç¨‹åºæ˜¯åœ¨è¿è¡Œæ—¶æ‰ç¼–è¯‘ï¼Œå› æ­¤å¾ˆå¤šç®€å•çš„ç¼–è¯‘é”™è¯¯åªèƒ½åœ¨è¿è¡Œæ—¶æ£€æµ‹åˆ°ï¼Œå½±å“å¼€å‘ä½“éªŒã€‚

éšç€ BPF CO-RE çš„è½åœ°ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨å†…æ ¸å¼€å‘äººå‘˜æä¾›çš„ libbpf åº“æ¥å¼€å‘ BPF ç¨‹åºï¼Œå¼€å‘æ–¹å¼å’Œç¼–å†™æ™®é€š C ç”¨æˆ·æ€ç¨‹åºä¸€æ ·ï¼šä¸€æ¬¡ç¼–è¯‘ç”Ÿæˆå°å‹çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚Libbpf ä½œä¸º BPF ç¨‹åºåŠ è½½å™¨ï¼Œæ¥ç®¡äº†é‡å®šå‘ã€åŠ è½½ã€éªŒè¯ç­‰åŠŸèƒ½ï¼ŒBPF ç¨‹åºå¼€å‘è€…åªéœ€è¦å…³æ³¨ BPF ç¨‹åºçš„æ­£ç¡®æ€§å’Œæ€§èƒ½å³å¯ã€‚è¿™ç§æ–¹å¼å°†å¼€é”€é™åˆ°äº†æœ€ä½ï¼Œä¸”å»é™¤äº†åºå¤§çš„ä¾èµ–å…³ç³»ï¼Œä½¿å¾—æ•´ä½“å¼€å‘æµç¨‹æ›´åŠ é¡ºç•…ã€‚

æ€§èƒ½ä¼˜åŒ–å¤§å¸ˆ Brendan Gregg åœ¨ç”¨ libbpf + BPF CO-RE è½¬æ¢ä¸€ä¸ª BCC å·¥å…·åç»™å‡ºäº†æ€§èƒ½å¯¹æ¯”æ•°æ®ï¼š

> As my colleague Jason pointed out, the memory footprint of opensnoop as CO-RE is much lower than opensnoop.py. 9 Mbytes for CO-RE vs 80 Mbytes for Python.

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨è¿è¡Œæ—¶ç›¸æ¯” BCC ç‰ˆæœ¬ï¼Œlibbpf + BPF CO-RE ç‰ˆæœ¬èŠ‚çº¦äº†è¿‘ 9 å€çš„å†…å­˜å¼€é”€ï¼Œè¿™å¯¹äºç‰©ç†å†…å­˜èµ„æºå·²ç»ç´§å¼ çš„æœåŠ¡å™¨æ¥è¯´ä¼šæ›´å‹å¥½ã€‚

![img](https://996station.com/wp-content/uploads/2022/11/20221126113835921.png?imageView2/0/format/webp/q/75)

å…³äº BCC å¯ä»¥å‚è€ƒ **æˆ‘çš„è¿™ç¯‡æ–‡ç« ä»‹ç»**[23]

### bpftrace

> bpftrace is a high-level tracing language for Linux eBPF and available in recent Linux kernels (4.x). bpftrace uses LLVM as a backend to compile scripts to eBPF bytecode and makes use of BCC for interacting with the Linux eBPF subsystem as well as existing Linux tracing capabilities: kernel dynamic tracing (kprobes), user-level dynamic tracing (uprobes), and tracepoints. The bpftrace language is inspired by awk, C and predecessor tracers such as DTrace and SystemTap.

![img](https://996station.com/wp-content/uploads/2022/11/20221126113822257.png?imageView2/0/format/webp/q/75)

### eBPF Go Library

![img](https://996station.com/wp-content/uploads/2022/11/20221126113803273.png?imageView2/0/format/webp/q/75)

### libbpf

![img](https://996station.com/wp-content/uploads/2022/11/20221126113623645.png?imageView2/0/format/webp/q/75)

## å‚è€ƒèµ„æ–™

- **The BSD Packet Filter: A New Architecture for User-level Packet Capture, Steven McCanne and Van Jacobso, December 19, 1992**[24]
- **eBPF Documentation: What is eBPF?**[25]
- **LWN: A thorough introduction to eBPF**[26]
- **Cilium Documentation: BPF and XDP Reference Guide**[27]
- **eBPF summit: The Future of eBPF based Networking and Security**[28]
- **eBPF - The Future of Networking & Security**[29]
- **eBPF - Rethinking the Linux Kernel**[30]
- **Linux Manual Page: bpf(2)**[31]
- **Linux Manual Page: bpf-helpers**[32]
- **Linux Kernel Documentation: Linux Socket Filtering aka Berkeley Packet Filter (BPF)**[33]
- **Dive into BPF: a list of reading material**[34]
- **LWN: eBPF materials**[35]
- **åŸºäº Ubuntu 20.04 çš„ eBPF ç¯å¢ƒæ­å»º**[36]

ç›¸å…³æ–‡ç« æ¨è

- **eBPF æŒ‡ä»¤é›†**[37]
- **eBPF tc å­ç³»ç»Ÿ**[38]
- **Linux Traffic Control**[39]
- **ç½‘å¡èšåˆ Bonding**[40]
- **Linux ç½‘ç»œåŒ…æ”¶å‘æµç¨‹**[41]

### å¼•ç”¨é“¾æ¥

[1]

BPF: *https://en.wikipedia.org/wiki/Berkeley_Packet_Filter*[2]

Github: *https://github.com/*[3]

The BSD Packet Filter: A New Architecture for User-level Packet Capture: *http://www.tcpdump.org/papers/bpf-usenix93.pdf*[4]

include/linux/filter.h: *https://github.com/torvalds/linux/blob/v5.8/include/linux/filter.h*[5]

include/linux/bpf.h: *https://github.com/torvalds/linux/blob/v5.8/include/linux/bpf.h*[6]

è¯¦è§è¿™é‡Œ: *https://github.com/iovisor/bcc/blob/master/docs/reference_guide.md#1-bpf_trace_printk*[7]

`read_trace_pipe`: *https://elixir.bootlin.com/linux/latest/source/tools/testing/selftests/bpf/trace_helpers.c#L120*[8]

`bpf_load.c`: *https://elixir.bootlin.com/linux/v5.4/source/samples/bpf/bpf_load.c#L659*[9]

`load_and_attach`: *https://elixir.bootlin.com/linux/v5.4/source/samples/bpf/bpf_load.c#L76*[10]

æˆ‘çš„è¿™ç¯‡åšæ–‡: *https://houmin.cc*[11]

Linux Manual Page: bpf-helpers: *https://man7.org/linux/man-pages/man7/bpf-helpers.7.html*[12]

include/linux/filter.h: *https://elixir.bootlin.com/linux/v5.4/source/include/linux/filter.h#L479*[13]

`bpf_map_update_elem`: *https://elixir.bootlin.com/linux/v5.4/source/kernel/bpf/helpers.c#L41*[14]

`bpf()`: *https://man7.org/linux/man-pages/man2/bpf.2.html*[15]

`bpf_load_program`: *https://elixir.bootlin.com/linux/v5.4/source/tools/lib/bpf/bpf.c#L316*[16]

`bpf_create_map`: *https://elixir.bootlin.com/linux/v5.4/source/tools/lib/bpf/bpf.c#L123*[17]

`bpf_map_lookup_elem`: *https://elixir.bootlin.com/linux/v5.4/source/tools/lib/bpf/bpf.c#L371*[18]

`bpf_map_update_elem`: *https://elixir.bootlin.com/linux/v5.4/source/tools/lib/bpf/bpf.c#L357*[19]

`bpf_map_delete_elem`: *https://elixir.bootlin.com/linux/v5.4/source/tools/lib/bpf/bpf.c#L408*[20]

`bpf_map_get_next_key`: *https://elixir.bootlin.com/linux/v5.4/source/tools/lib/bpf/bpf.c#L419*[21]

Linux Manual Page: bpf-helpers: *https://man7.org/linux/man-pages/man7/bpf-helpers.7.html*[22]

ä¸‹é¢å‡½æ•°: *https://elixir.bootlin.com/linux/v5.17-rc8/source/kernel/bpf/syscall.c#L3137*[23]

æˆ‘çš„è¿™ç¯‡æ–‡ç« ä»‹ç»: *https://houmin.cc/posts/6a8748a1/*[24]

The BSD Packet Filter: A New Architecture for User-level Packet Capture, Steven McCanne and Van Jacobso, December 19, 1992: *http://www.tcpdump.org/papers/bpf-usenix93.pdf*[25]

eBPF Documentation: What is eBPF?: *https://ebpf.io/what-is-ebpf/*[26]

LWN: A thorough introduction to eBPF: *https://lwn.net/Articles/740157/*[27]

Cilium Documentation: BPF and XDP Reference Guide: *https://docs.cilium.io/en/stable/bpf/*[28]

eBPF summit: The Future of eBPF based Networking and Security: *https://www.youtube.com/watch?v=slBAYUDABDA*[29]

eBPF - The Future of Networking & Security: *https://cilium.io/blog/2020/11/10/ebpf-future-of-networking/*[30]

eBPF - Rethinking the Linux Kernel: *https://www.youtube.com/watch?v=f-oTe-dmfyI*[31]

Linux Manual Page: bpf(2): *https://man7.org/linux/man-pages/man2/bpf.2.html*[32]

Linux Manual Page: bpf-helpers: *https://man7.org/linux/man-pages/man7/bpf-helpers.7.html*[33]

Linux Kernel Documentation: Linux Socket Filtering aka Berkeley Packet Filter (BPF): *https://www.kernel.org/doc/Documentation/networking/filter.txt*[34]

Dive into BPF: a list of reading material: *https://qmonnet.github.io/whirl-offload/2016/09/01/dive-into-bpf/*[35]

LWN: eBPF materials: *https://lwn.net/Kernel/Index/#Berkeley_Packet_Filter*[36]

åŸºäº Ubuntu 20.04 çš„ eBPF ç¯å¢ƒæ­å»º: *https://www.ebpf.top/post/ebpf_c_env/*[37]

eBPF æŒ‡ä»¤é›†: *https://houmin.cc/posts/5150fab3/*[38]

eBPF tc å­ç³»ç»Ÿ: *https://houmin.cc/posts/28ca4f79/*[39]

Linux Traffic Control: *https://houmin.cc/posts/8278f23c/*[40]

ç½‘å¡èšåˆ Bonding: *https://houmin.cc/posts/e9c4d3e9/*[41]

Linux ç½‘ç»œåŒ…æ”¶å‘æµç¨‹: *https://houmin.cc/posts/941301e/*

## ä½œè€…

äº‘åŸç”Ÿå®éªŒå®¤

## åŸæ–‡é“¾æ¥

https://mp.weixin.qq.com/s/zCjk5WmnwLD0J3J9gC4e0Q
